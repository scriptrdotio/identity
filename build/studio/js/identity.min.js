!function(a){"use strict";var b=a.module("ngLoadingOverlay",[]);b.provider("$loadingOverlayConfig",function(){var a={bg:"rgba(0, 0, 0, 0.5)",textColor:"#fff",template:"<b>Please wait</b>",zIndex:9999};this.defaultConfig=function(b,c,d,e){a.bg=c||a.bg,a.template=b||a.template,a.textColor=d||a.textColor,a.zIndex=e||a.zIndex},this.$get=function(){return{get:function(){return a}}}}),b.service("$loadingOverlay",["$compile","$rootScope","$sce","$loadingOverlayConfig",function(b,c,d,e){var f=0,g=e.get(),h=a.element('<div id="ng-loading-overlay" ng-show="show" style="display: -webkit-box; display: -moz-box; display: -ms-flexbox; display: -webkit-flex; display: flex; align-items: center; justify-content: center; position:absolute; left:0; height: 100%; width: 100%;" ng-style="{\'background\': bg, \'color\': textColor, \'top\': positionTop, \'z-index\': zIndex}"><div style="position:relative;opacity: 1;" ng-bind-html="template"></div></div>'),i=c.$new();i.show=!1,a.element(document).ready(function(){h=b(h)(i),a.element(document.body).append(h)}),this.show=function(b,c,e,h){var j=a.element(document.body);f+=1,i.template=b?d.trustAsHtml(b):d.trustAsHtml(g.template),i.bg=c||g.bg,i.textColor=e||g.textColor,i.zIndex=h||g.zIndex,i.positionTop=window.pageYOffset,console.log(i.positionTop),j.css("overflow","hidden"),i.show=!0},this.hide=function(){f&&(f-=1),f||(a.element(document.body).css("overflow","auto"),i.show=!1)}}])}(window.angular),angular.module("Identity",["agGrid","schemaForm","ui.bootstrap","ngRoute","ngAnimate","ngSanitize","ngMaterial","ngMessages","material.svgAssetsCache","angularSpectrumColorpicker","angular-underscore/filters","ui.codemirror","mgcrea.ngStrap","mgcrea.ngStrap.modal","pascalprecht.translate","ui.select","ui.highlight","mgcrea.ngStrap.select","ngSchemaFormFile","ngLoadingOverlay","WsClient","HttpClient","DataService"]),angular.module("Identity").component("scriptrIdentityMain",{bindings:{identityLayout:"@"},templateUrl:"/identity/view/javascript/components/main/identity.html",controller:["$location","$scope","$rootScope","httpClient","identityForms","$routeParams","$timeout","$mdDialog","$uibModal","$route","identityConfig","$loadingOverlay","identityFactory",function(a,b,c,d,e,f,g,h,i,j,k,l,m){var n=this;this.$onInit=function(){console.log(">>>>>>>>>>>>> identityLayout: "+this.identityLayout);var a=this;a.deviceTitle="Identity Manager",a.renderGrid=!0,a.identityForms=e,a.gridId=void 0!==this.identityLayout&&null!=this.identityLayout&&""!=this.identityLayout?this.identityLayout:"device",a.identifierProperty=k.device.identifierProperty,a.deviceTabClass="btnSelected",a.gridAPI=k.device.apis.list,a.copyTooltip="Copy Token",angular.element(document.querySelector("body")).addClass(k.theme),a.removeDeviceConfig={api:k.device.apis.delete,queryParam:"id"},a.removeUserConfig={api:k.user.apis.delete,queryParam:"id"},a.removeGroupConfig={api:k.group.apis.delete,queryParam:"name"},a.saveDeviceConfig={api:k.device.apis.save,schemaFormDefinition:a.identityForms.device},a.saveGroupConfig={api:k.group.apis.save,schemaFormDefinition:a.identityForms.group},a.saveUserConfig={api:k.user.apis.save,schemaFormDefinition:a.identityForms.user}},n.changeTab=function(a){n.gridId=a,"group"==n.gridId?(n.deviceTabClass="",n.userTabClass="",n.groupTabClass="btnSelected",n.identifierProperty=k.group.identifierProperty,n.gridAPI=k.group.apis.list):"device"==n.gridId?(n.deviceTabClass="btnSelected",n.identifierProperty=k.device.identifierProperty,n.groupTabClass="",n.userTabClass="",n.gridAPI=k.device.apis.list):"user"==n.gridId&&(n.userTabClass="btnSelected",n.identifierProperty=k.user.identifierProperty,n.groupTabClass="",n.deviceTabClass="",n.gridAPI=k.user.apis.list)},n.groupsColDef=[{headerName:"",checkboxSelection:!0,headerCheckboxSelection:!0,width:30},{headerName:"Group Name",field:"name",cellClass:"textWrap",editable:!1,cellRenderer:function(a){return a.value?a.value.split("_")[0]:"N/A"}},{headerName:"Number of Devices",field:"count",cellClass:"textWrap",editable:!1,cellRenderer:function(a){return a.value?a.value.split("_")[0]:"N/A"}},{headerName:"",width:60,cellClass:"textWrap",editable:!1,cellRenderer:function(a){var b=document.createElement("div");return b.innerHTML='<button class="btn btn-default btn-block" tooltip-append-to-body="true" tooltip-placement="auto" uib-tooltip="View Group"><i class="glyphicon glyphicon-eye-open" aria-hidden="true"></i></button>',b.querySelectorAll(".btn")[0].addEventListener("click",function(b){l.show('<i class="fa fa-spinner fa-spin fa-1x"></i>&nbsp;<b>Fetching group...</b>'),n.getIdentity(a)}),b}},{headerName:"",width:60,cellClass:"textWrap",editable:!1,cellRenderer:function(a){var b=document.createElement("div");return b.innerHTML='<button class="btn btn-default btn-block" tooltip-append-to-body="true" tooltip-placement="auto" uib-tooltip="Edit Group"><i class="glyphicon glyphicon-edit" aria-hidden="true"></i></button>',b.querySelectorAll(".btn")[0].addEventListener("click",function(b){n.loadEditGroupOverlay(a.data,n.identityForms.group,k.group.apis.save)}),b}},{headerName:"",width:60,cellClass:"textWrap",editable:!1,cellRenderer:function(a){var b=document.createElement("div");return b.innerHTML='<button class="btn btn-default btn-block" tooltip-append-to-body="true" tooltip-placement="auto" uib-tooltip="Delete Group"><i class="glyphicon glyphicon-trash" aria-hidden="true"></i></button>',b.querySelectorAll(".btn")[0].addEventListener("click",function(b){n.showConfirmDialog(a)}),b}}],n.devicesColDef=[{headerName:"",checkboxSelection:!0,width:50,suppressSorting:!0},{headerName:"Device Name",field:"name",cellClass:"textWrap",editable:!1,cellRenderer:function(a){return a.value?a.value.split("_")[0]:"N/A"}},{headerName:"Device ID",field:"id",cellClass:"textWrap",editable:!1,cellRenderer:function(a){return a.value?a.value.split("_")[0]:"N/A"}},{headerName:"Token",field:"auth_token",cellClass:"textWrap",editable:!1,suppressSorting:!0,tooltipField:"auth_token",cellRenderer:function(a){if(a.value){var b=document.createElement("div"),c='<span tooltip-placement="auto" tooltip-append-to-body="true" uib-tooltip="'+n.copyTooltip+'" class="icon"><i class="glyphicon glyphicon-duplicate" aria-hidden="true"></i></span>',d="..."+a.value.substr(a.value.length-8,8);b.innerHTML=d+"&nbsp;&nbsp;&nbsp;"+c;return b.querySelectorAll(".icon")[0].addEventListener("click",function(b){n.copyToClipboard(a)}),b}return"N/A"}},{headerName:"Status",field:"isSuspended",cellClass:"textWrap",editable:!1,cellRenderer:function(a){var b="Active";if(null!=a.value){"true"==a.value&&(b="Suspended")}return b}},{headerName:"Last Modified",field:"lastModifiedDate",cellClass:"textWrap",editable:!1,cellRenderer:function(a){return a.value?moment(a.value).format("DD-MMM-YYYY hh:mm A"):"N/A"}},{headerName:" ",field:"value",suppressSorting:!0,cellRenderer:function(a){var b,c=document.createElement("div");return c.innerHTML='<button class="btn btn-default btn-view" tooltip-append-to-body="true" tooltip-placement="auto" uib-tooltip="View Device"><i class="glyphicon glyphicon-eye-open" aria-hidden="true"></i></button>',b=c.querySelectorAll(".btn-view")[0],b.addEventListener("click",function(){l.show('<i class="fa fa-spinner fa-spin fa-1x"></i>&nbsp;<b>Fetching device...</b>'),n.getIdentity(a)}),c},width:60},{headerName:" ",field:"value",suppressSorting:!0,cellRenderer:function(a){var b,c=document.createElement("div");return c.innerHTML='<button class="btn btn-default btn-edit" tooltip-append-to-body="true" tooltip-placement="auto" uib-tooltip="Edit Device"><i class="glyphicon glyphicon-edit" aria-hidden="true"></i></button>',b=c.querySelectorAll(".btn-edit")[0],b.addEventListener("click",function(b){n.loadEditIdentityOverlay.bind(n,a.data)()}),c},width:60},{headerName:" ",field:"value",suppressSorting:!0,cellRenderer:function(a){var b,c=document.createElement("div");return c.innerHTML='<button class="btn btn-default btn-delete" tooltip-append-to-body="true" tooltip-placement="auto" uib-tooltip="Delete Device"><i class="glyphicon glyphicon-trash" aria-hidden="true"></i></button>',b=c.querySelectorAll(".btn-delete")[0],b.addEventListener("click",function(){n.showConfirmDialog(a)}),c},width:60},{hide:!0,field:"description"}],n.usersColDef=[{headerName:"",checkboxSelection:!0,headerCheckboxSelection:!0,width:30},{headerName:"Login",field:"id",cellClass:"textWrap",editable:!1,cellRenderer:function(a){return a.value?a.value.split("_")[0]:"N/A"}},{headerName:"User Name",field:"name",cellClass:"textWrap",editable:!1,cellRenderer:function(a){return a.value?a.value.split("_")[0]:"N/A"}},{headerName:"Email",field:"email",cellClass:"textWrap",editable:!1,cellRenderer:function(a){return a.value?a.value.split("_")[0]:"N/A"}},{headerName:"Status",field:"isSuspended",cellClass:"textWrap",editable:!1,cellRenderer:function(a){var b="Active";if(null!=a.value){"true"==a.value&&(b="Suspended")}return b}},{headerName:"Last Modified",field:"lastModifiedDate",cellClass:"textWrap",editable:!1,cellRenderer:function(a){return a.value?moment(a.value).format("DD-MMM-YYYY hh:mm A"):"N/A"}},{headerName:"",width:60,cellClass:"textWrap",editable:!1,cellRenderer:function(a){var b=document.createElement("div");return b.innerHTML='<button class="btn btn-default btn-block" tooltip-append-to-body="true" tooltip-placement="auto" uib-tooltip="View User"><i class="glyphicon glyphicon-eye-open" aria-hidden="true"></i></button>',b.querySelectorAll(".btn")[0].addEventListener("click",function(b){l.show('<i class="fa fa-spinner fa-spin fa-1x"></i>&nbsp;<b>Fetching user...</b>'),n.getIdentity(a)}),b}},{headerName:"",width:60,cellClass:"textWrap",editable:!1,cellRenderer:function(a){var b=document.createElement("div");return b.innerHTML='<button class="btn btn-default btn-block" tooltip-append-to-body="true" tooltip-placement="auto" uib-tooltip="Edit User"><i class="glyphicon glyphicon-edit" aria-hidden="true"></i></button>',b.querySelectorAll(".btn")[0].addEventListener("click",function(b){n.loadEditIdentityOverlay.bind(n,a.data)()}),b}},{headerName:"",width:60,cellClass:"textWrap",editable:!1,cellRenderer:function(a){var b=document.createElement("div");return b.innerHTML='<button class="btn btn-default btn-block" tooltip-append-to-body="true" tooltip-placement="auto" uib-tooltip="Delete User"><i class="glyphicon glyphicon-trash" aria-hidden="true"></i></button>',b.querySelectorAll(".btn")[0].addEventListener("click",function(b){n.showConfirmDialog(a)}),b}}],n.getIdentity=function(a){var b,c;"device"==n.gridId||"user"==n.gridId?(c={id:a.data.id,module:n.gridId},b=k[n.gridId].apis.get):"group"==n.gridId&&(c={name:a.data.name},b=k.group.apis.getGroupDevicesToView),d.post(b,c).then(function(b,c){if(b.status&&"failure"==b.status)return l.hide(),void n.showAlert("danger","Could not fetch "+n.gridId+", please try again later");l.hide();var d="",e="",f={};"device"==n.gridId||"user"==n.gridId?(f={grid:a.api,identityData:a.data,parent:n,identityInfo:b},d="viewIdentityDialogCtrl",e="/identity/view/html/views/viewIdentity.html"):"group"==n.gridId&&(f={grid:a.api,groupData:a.data,parent:n,groupInfo:b},d="viewGroupDialogCtrl",e="/identity/view/html/views/groups/viewGroup.html"),h.show({controller:d,controllerAs:"vm",templateUrl:e,clickOutsideToClose:!0,escapeToClose:!0,locals:f,ok:"Close"})},function(a){console.dir(a);a.data&&a.data.metadata&&a.data.metadata.description&&a.data.metadata.description.en?a.data.metadata.description.en:a.errorDetail&&a.errorDetail,l.hide(),n.showAlert("danger","Could not fetch "+n.gridId+", please try again later")})},n.showAlert=function(a,c){b.$broadcast("showGridAlert-"+n.gridId,{type:a,content:c})},n.callBackendApiPost=function(a,b,c,d){console.log("POST calling backend api <"+a+"> with params "+JSON.stringify(b)),n._callBackendApi(a,b,"P",c,d)},n._callBackendApi=function(a,b,c,e,f){var g=d.post;"G"==c&&(g=d.get),g(a,b).then(function(a,b){a&&a.status&&"failure"==a.status?"function"==typeof f&&f(a):"function"==typeof e&&e(a)},function(a){"function"==typeof f&&f(a)})},n.loadEditGroupOverlay=function(a,c,e){l.show('<i class="fa fa-spinner fa-spin fa-1x"></i>&nbsp;<b>Fetching group...</b>'),d.post(k.group.apis.getGroupDevices,a).then(function(d,f){if(d.status&&"failure"==d.status){var g="Unknown error";return d.data&&d.data.metadata&&d.data.metadata.description&&d.data.metadata.description.en?g=d.data.metadata.description.en:d.errorDetail&&(g=d.errorDetail),void n.showAlert("danger","Could not fetch group: "+g)}n.closeAlert();var h=angular.copy(c);h.title="Edit "+h.title;var j={label:h.title,buttons:{save:{label:"Save"},cancel:{label:"Cancel"}},schema:angular.copy(h.schema),form:angular.copy(h.form),model:{name:a.name,devices:d.devices,originalName:a.name,originalDevices:d.devices}};l.hide(),i.open({animation:!0,component:"formOverlay",size:"lg",scope:b,resolve:{widget:function(){return j}}}).result.then(function(a){if(console.log("Model Data",a),"cancel"!=a){var c=function(a){null!=a.scriptHandleId&&""!=a.scriptHandleId?(l.show('<i class="fa fa-spinner fa-spin fa-1x"></i>&nbsp;<b>Saving group and updating devices...</b>'),m.getJobStatus(e,{scriptHandleId:a.scriptHandleId},30,function(a){a&&"success"==a?(b.$broadcast("updateGridData-"+n.gridId,{}),n.showAlert("success","Successfully saved group and updated devices")):n.showAlert("warning",a)},function(a){n.showAlert("warning","Successfully saved group. Error when updating devices")})):(b.$broadcast("updateGridData-"+n.gridId,{}),n.showAlert("success","Group saved successfully"))},d=function(a){var b="Unknown error";a.data&&a.data.metadata&&a.data.metadata.description&&a.data.metadata.description.en?b=a.data.metadata.description.en:a.errorDetail&&(b=a.errorDetail),n.showAlert("danger","Could not save group: "+b)};a.update=!0,a.originalDevices=j.model.originalDevices,a.originalName!=a.name&&(a.newName=a.name,a.name=a.originalName);var f=a.originalDevices.sort(),g=a.devices.sort();f.length==g.length&&f.every(function(a,b){return a===g[b]})&&(a.updateDevices=!1),n.callBackendApiPost(e,a,c,d)}},function(){console.info("modal-component for widget update dismissed at: "+new Date)})},function(a){if(console.dir(a),"success"==a.status)return b.$broadcast("updateGridData-"+n.gridId,{}),void n.showAlert("success","Group saved successfully");var c="Unknown error";a.data&&a.data.metadata&&a.data.metadata.description&&a.data.metadata.description.en?c=a.data.metadata.description.en:a.errorDetail&&(c=a.errorDetail),n.showAlert("danger","Could not save group, please try again later: "+c)})},n.temp=function(a,c,d){var f=this,g=e[f.gridId],h=f.gridId.charAt(0).toUpperCase()+f.gridId.substring(1);if(console.log(f),c.status&&"failure"==c.status){var j="Unknown error";return c.data&&c.data.metadata&&c.data.metadata.description&&c.data.metadata.description.en?j=c.data.metadata.description.en:c.errorDetail&&(j=c.errorDetail),void f.showAlert("danger","Could not fetch "+f.gridId+", please try again later: "+j)}var m=[];m=c.groups instanceof Array?c.groups:[c.groups];var n,o=["name","groups","creator","versionNumber","latest","lastModifiedBy","creationDate","lastModifiedDate","isSuspended","id","meta.types","workflowState"];"device"==f.gridId?(o.push("auth_token","description"),n=k.device.apis.save):"user"==f.gridId&&(o.push("email","token","login"),n=k.user.apis.save);var p=[],q=c["meta.types"];Object.keys(c).forEach(function(a){if(o.indexOf(a)<0){f.hasAttrs=!0;var b={};b.name=a,b.type=q[a],b.value=c[a],p.push(b)}}),f.closeAlert();var r=angular.copy(g);r.title="Edit "+r.title;var s=angular.copy(r.form),t=["name","id"],u=angular.copy(r.schema);u.required=t,u.properties.id.readonly=!0;var v={label:r.title,buttons:{save:{label:"Save"},cancel:{label:"Cancel"}},schema:u,form:s,model:{name:a.name,id:a.id,isSuspended:c.isSuspended,groups:m}};"device"==f.gridId?(v.model.deviceAttrs=p,v.model.description=a.description):"user"==f.gridId&&(v.model.userAttrs=p,v.model.email=a.email),l.hide();var f=this;i.open({animation:!0,component:"formOverlay",size:"lg",scope:b,resolve:{widget:function(){return v}}}).result.then(function(a){if("cancel"!=a){var c=function(a){b.$broadcast("updateGridData-"+f.gridId,{}),f.showAlert("success",h+" saved successfully")},d=function(a){var b="Unknown error";a.data&&a.data.metadata&&a.data.metadata.description&&a.data.metadata.description.en?b=a.data.metadata.description.en:a.errorDetail&&(b=a.errorDetail),f.showAlert("danger","Could not save "+f.gridId+", please try again later: "+b)};a.update=!0,f.callBackendApiPost(n,a,c,d)}},function(){console.info("modal-component for widget update dismissed at: "+new Date)})},this.loadEditIdentityOverlay=function(a){var c=this;l.show('<i class="fa fa-spinner fa-spin fa-1x"></i>&nbsp;<b>Fetching '+c.gridId+"...</b>"),d.post(k[c.gridId].apis.get,{id:a.id,module:c.gridId}).then(c.temp.bind(c,a),function(a){if("success"==a.status){b.$broadcast("updateGridData-"+c.gridId,{});var d=c.gridId.charAt(0).toUpperCase()+c.gridId.substring(1);return void c.showAlert("success",d+" saved successfully")}var e="Unknown error";a.data&&a.data.metadata&&a.data.metadata.description&&a.data.metadata.description.en?e=a.data.metadata.description.en:a.errorDetail&&(e=a.errorDetail),c.showAlert("danger","Could not save "+c.gridId+", please try again later: "+e)})},n.closeAlert=function(){this.showError=!1},n.copyToClipboard=function(a){navigator.clipboard.writeText(a.value).then(function(){console.log("Copying to clipboard was successful"),n.copyTooltip="Copied!",a.refreshCell()},function(a){console.error("Could not copy text: ",a)})},n.showConfirmDialog=function(a){h.show({controller:"confirmDeleteDialogCtrl",controllerAs:"vm",templateUrl:"/identity/view/html/views/confirmationDialog.html",clickOutsideToClose:!0,escapeToClose:!0,locals:{dataObject:a.data,grid:a.api,parent:n},ok:"Close"})}}]}),angular.module("Identity").controller("confirmDeleteDialogCtrl",["httpClient","identityConfig","dataObject","grid","$scope","parent","$mdDialog","$loadingOverlay",function(a,b,c,d,e,f,g,h){var i=this;i.parent=f,i.identifier=c[i.parent.identifierProperty],i.grid=d,i.config=b,i.deleteApi=b[i.parent.gridId].apis.delete,i.header="Confirm Delete",i.init=function(){i.promptMessage="Are you sure you want to delete '"+i.identifier+"'?"},i.deleteIdentity=function(){i.closeDialog(),h.show('<i class="fa fa-spinner fa-spin fa-1x"></i>&nbsp;<b>Deleting '+i.parent.gridId+"...</b>");var b={},c=i.parent.gridId.charAt(0).toUpperCase()+i.parent.gridId.substring(1);b[i.parent.identifierProperty]=i.identifier,b.module=i.parent.gridId,a.post(i.deleteApi,b).then(function(a,b){if(a.status&&"failure"==a.status)return void i.parent.showAlert("danger","Could not delete "+i.parent.gridId+", please try again later");i.parent.showAlert("success",c+" deleted successfully"),i.grid.refreshInfiniteCache(),i.grid.deselectAll()},function(a){if(i.grid.hideOverlay(),"success"==a.status)return i.parent.showAlert("success",c+" deleted successfully"),void i.grid.refreshInfiniteCache();a.data&&a.data.metadata&&a.data.metadata.description&&a.data.metadata.description.en?a.data.metadata.description.en:a.errorDetail&&a.errorDetail,i.parent.showAlert("danger","Could not delete "+i.parent.gridId+", please try again later")})},i.closeDialog=function(){g.hide()}}]),angular.module("Identity").controller("viewIdentityDialogCtrl",["$timeout","httpClient","identityData","grid","parent","$mdDialog","$scope","identityConfig","identityInfo",function(a,b,c,d,e,f,g,h,i){var j=this;j.identityData=c,j.identityId=c.id,j.parent=e,j.gridId=j.parent.gridId.charAt(0).toUpperCase()+j.parent.gridId.substring(1),j.grid=d,j.identityFetched=!1,j.hidePromptMessage=!1,j.showTokenButtons=!0,j.deleteApi=h[j.parent.gridId].apis.delete,j.getApi=h[j.parent.gridId].apis.get,j.copyTooltip="Copy Token",j.showActionButtons=!0,j.init=function(){j.name=i.name?i.name:"N/A",j.id=i.id?i.id:"N/A","device"==j.parent.gridId&&(j.identityNameLabel="Device Name",j.identityIdLabel="Device ID",j.description=i.description?i.description:"N/A",j.token=i.auth_token?i.auth_token:"N/A"),"user"==j.parent.gridId&&(j.identityNameLabel="User Name",j.identityIdLabel="Login",j.email=i.email?i.email:"N/A"),null!=i.groups?i.groups instanceof Array?j.groups=i.groups:j.groups=[i.groups]:j.groups=["N/A"];var a="Active";null!=i.isSuspended&&"true"==i.isSuspended&&(a="Suspended"),j.status=a,j.hasAttrs=!1;var b=["name","groups","creator","versionNumber","latest","lastModifiedBy","creationDate","lastModifiedDate","isSuspended","id","meta.types","workflowState"];"device"==j.parent.gridId?b.push("auth_token","description"):"user"==j.parent.gridId&&b.push("email","token","login");var c=[],d=i["meta.types"];Object.keys(i).forEach(function(a){if(b.indexOf(a)<0){j.hasAttrs=!0;var e={};e.name=a,e.type=d[a],e.value=i[a],c.push(e)}}),j.identityAttrs=c,j.identityFetched=!0,j.hidePromptMessage=!0},j.confirmationDeleteIdentity=function(){j.showActionButtons=!1},j.editIdentity=function(){j.closeDialog();var a=j.parent.identityForms[j.parent.gridId];j.parent.loadEditIdentityOverlay(j.identityData,a,h[j.parent.gridId].apis.save)},j.copyToken=function(){navigator.clipboard.writeText(j.token).then(function(){j.copyTooltip="Copied!"},function(a){var b="Unknown error";a.errorDetail&&(b=a.errorDetail),j.showAlert("danger","Could not copy token: "+b)})},j.resetCopyTooltip=function(){a(function(){j.copyTooltip="Copy Token"},500)},j.regenerateToken=function(){j.generateToken("regenerate")},j.generateToken=function(a){a=null!=a&&"regenerate"==a?"regenerate":"generate";var c={id:j.id,action:a};b.post(h.device.apis.generate,c).then(function(b,c){if(j.showTokenButtons=!0,b.status&&"failure"==b.status){var d="Unknown error";return b.errorDetail&&(d=b.errorDetail),void j.showAlert("danger","Failed to "+a+": "+d)}j.token=b.token?b.token:"N/A",j.grid.refreshInfiniteCache()},function(b){j.showTokenButtons=!0;var c="Unknown error";b.data&&b.data.metadata&&b.data.metadata.description&&b.data.metadata.description.en?c=b.data.metadata.description.en:b.errorDetail&&(c=b.errorDetail),j.showAlert("danger","Failed to "+a+": "+c)})},j.revokeToken=function(){var a={id:j.id};b.post(h.device.apis.revoke,a).then(function(a,b){if(j.showTokenButtons=!0,a.status&&"failure"==a.status){var c="Unknown error";return a.errorDetail&&(c=a.errorDetail),void j.showAlert("danger","Could not delete token: "+c)}j.token="N/A",j.grid.refreshInfiniteCache()},function(a){j.showTokenButtons=!0;var b="Unknown error";a.data&&a.data.metadata&&a.data.metadata.description&&a.data.metadata.description.en?b=a.data.metadata.description.en:a.errorDetail&&(b=a.errorDetail),j.showAlert("danger","Could not delete token: "+b)})},j.deleteIdentity=function(){var a={id:j.identityId,module:j.parent.gridId};b.post(j.deleteApi,a).then(function(a,b){if(a.status&&"failure"==a.status){j.showActionButtons=!0;var c="Unknown error";return a.errorDetail&&(c=a.errorDetail),void j.showAlert("danger","Could not delete "+j.parent.gridId+": "+c)}j.parent.showAlert("success",j.gridId+" deleted successfully"),j.grid.refreshInfiniteCache(),j.grid.deselectAll(),j.closeDialog()},function(a){if(console.dir(a),"success"==a.status)return j.showActionButtons=!0,j.closeDialog(),j.parent.showAlert("success",j.gridId+" deleted successfully"),j.grid.refreshInfiniteCache(),void j.closeDialog();var b="Unknown error";a.data&&a.data.metadata&&a.data.metadata.description&&a.data.metadata.description.en?b=a.data.metadata.description.en:a.errorDetail&&(b=a.errorDetail),j.showAlert("danger","Could not delete "+j.parent.gridId+": "+b)})},j.confirmTokenAction=function(a){"delete"==a?(j.actionDelete=!0,j.tokenActionMsg="Are you sure you want to delete this token?"):"regenerate"==a&&(j.actionDelete=!1,j.tokenActionMsg="Are you sure you want to regenerate this token?"),j.showTokenButtons=!1},j.cancelTokenAction=function(){j.showTokenButtons=!0},j.cancelActionButtons=function(){j.showActionButtons=!0},j.showPromptMessage=function(b,c,d){j.isLoading=c,j.promptMessage={type:b,content:d},j.hidePromptMessage=!1,a(function(){j.hidePromptMessage=!0},5e3)},j.showAlert=function(a,b){this.message={type:a,content:b},j.hasAlert=!0},j.closeAlert=function(){j.hasAlert=!1},j.closeDialog=function(){f.hide()}}]),angular.module("Identity").controller("viewGroupDialogCtrl",["$timeout","grid","httpClient","parent","groupData","$mdDialog","$scope","identityConfig","groupInfo",function(a,b,c,d,e,f,g,h,i){var j=this;j.groupData=e,j.grid=b,j.groupInfo=i,j.groupName=e.name,j.parent=d,j.showActionButtons=!0,j.groupFetched=!1,j.init=function(){j.name=i.name?i.name:"N/A",null!=i.devices&&i.devices.length>0?i.devices instanceof Array?j.devices=i.devices:j.devices=[i.devices]:j.devices="N/A",j.groupFetched=!0,j.hidePromptMessage=!0},j.deleteGroup=function(){var a={name:j.groupName,module:"group"};c.post(h.group.apis.delete,a).then(function(a,b){if(a.status&&"failure"==a.status)return j.showActionButtons=!0,void j.showAlert("danger","Could not delete group, please try again later");j.parent.showAlert("success","Group deleted successfully"),j.grid.refreshInfiniteCache(),j.grid.deselectAll(),j.closeDialog()},function(a){if(console.dir(a),"success"==a.status)return j.showActionButtons=!0,j.closeDialog(),j.parent.showAlert("success","Group deleted successfully"),j.grid.refreshInfiniteCache(),void j.closeDialog();a.data&&a.data.metadata&&a.data.metadata.description&&a.data.metadata.description.en?a.data.metadata.description.en:a.errorDetail&&a.errorDetail,j.showAlert("danger","Could not delete group, please try again later")})},j.confirmationDeleteGroup=function(){j.showActionButtons=!1},j.cancelActionButtons=function(){j.showActionButtons=!0},j.editGroup=function(){j.closeDialog();var a=j.parent.identityForms.group;j.parent.loadEditGroupOverlay(j.groupData,a,h.group.apis.save)},j.showPromptMessage=function(b,c,d){j.isLoading=c,j.promptMessage={type:b,content:d},j.hidePromptMessage=!1,a(function(){j.hidePromptMessage=!0},5e3)},j.showAlert=function(a,b){this.message={type:a,content:b},j.hasAlert=!0},j.closeAlert=function(){j.hasAlert=!1},j.closeDialog=function(){f.hide()}}]),angular.module("Identity").component("formOverlay",{bindings:{resolve:"<",close:"&",dismiss:"&"},templateUrl:"/identity/view/javascript/components/forms/overlayForm.html",controller:["$scope",function(a){var b=this;this.$onInit=function(){this.widget=this.resolve.widget,a.$broadcast("schemaFormRedraw"),this.frmGlobalOptions={destroyStrategy:"remove",formDefaults:{feedback:!1},validationMessage:{302:"Required"}},this.widget&&(this.widget.schema&&(this.schema=angular.copy(this.widget.schema)),this.widget.form&&(this.form=angular.copy(this.widget.form)),this.model=this.widget.model?angular.copy(this.widget.model):{},this.widget.onFormModelChange&&(this.frmGlobalOptions.formDefaults.onChange=this.widget.onFormModelChange))},this.highlightTabs=function(a){var b=$('form[name="'+a+'"]'),c=b.find("ul li"),d=b.find(".tab-pane")||[];b.find("ul li a span.badge").remove();for(var e=0;e<d.length;e++){var f=$(d[e]).find("div.ng-invalid").length;f>0&&$(c[e].childNodes[0]).append('<span class="badge sf-badge-error">'+f+"</span>")}},this.onSubmit=function(c){a.$broadcast("schemaFormValidate"),console.log(this.model),setTimeout(function(){b.highlightTabs(c.$name)},100),c.$valid&&(this.close({$value:this.model}),console.log("component_form_parent",this.model))},this.onCancel=function(a){this.schema={},this.form={},this.model=angular.copy(this.widget.options),this.dismiss({$value:"cancel"})}}]}),angular.module("Identity").component("uploadFileComponent",{bindings:{resolve:"<",close:"&",dismiss:"&"},templateUrl:"/identity/view/javascript/components/forms/uploadFile.html",controller:["$scope","httpClient","$q","identityConfig","$loadingOverlay","identityFactory",function(a,b,c,d,e,f){var g=this;g.showLoading=!1,this.$onInit=function(){console.log(a),this.widget=this.resolve.widget,g.gridType=this.resolve.widget.parent.gridEventsId,this.gridTypeToUpperCase=g.gridType.charAt(0).toUpperCase()+g.gridType.substring(1),a.$broadcast("schemaFormRedraw"),this.frmGlobalOptions={destroyStrategy:"remove",formDefaults:{feedback:!1}},this.widget&&(this.parent=this.widget.parent,this.widget.schema&&(this.schema=angular.copy(this.widget.schema)),this.widget.form&&(this.form=angular.copy(this.widget.form)),this.model=this.widget.model?angular.copy(this.widget.model):{},this.widget.onFormModelChange&&(this.frmGlobalOptions.formDefaults.onChange=this.widget.onFormModelChange))},this.onCancel=function(a){this.schema={},this.form={},this.model=angular.copy(this.widget.options),this.dismiss({$value:"cancel"})},this.save=function(h){if(a.$broadcast("schemaFormValidate"),h.$valid){g.showLoading=!0,e.show('<i class="fa fa-spinner fa-spin fa-1x"></i>&nbsp;<b>Uploading CSV, please wait...</b>');var i=c.defer(),j=new FormData;for(var k in this.model)Array.isArray(this.model[k])?_.forEach(this.model[k],function(a){j.append(k,a)}):j.append(k,this.model[k]);return j.append("gridType",g.gridType),b.post(d.reports.apis.import,j,null,!0).then(function(a,b){"failure"==a.status?(g.showLoading=!1,g.showAlert("danger",a.errorDetail)):f.getJobStatus(d.reports.apis.import,{scriptHandleId:a.scriptHandleId},30,function(c){g.showLoading=!1,c.status&&"success"==c.status?(g.showAlert("success","The "+g.gridType+"s have been imported successfully"),g.parent._createNewDatasource(),i.resolve(a,b)):(g.showAlert("danger",c.errorDetail?c.errorDetail:"Failed to import "+g.gridType+"s"),i.reject(c.errorCode,c.errorDetail))},function(a){g.showAlert("danger",a||"Failed to import "+g.gridType+"s"),g.showLoading=!1,i.reject(a)})},function(a){g.showAlert("danger",a.data.response.metadata.errorDetail),g.showLoading=!1,i.reject(a)}),i.promise}},this.downloadTemplate=function(){var a;"device"==g.gridType?a={templateKey:"devicesTemplate",attachment:"devicesTemplate.csv"}:"user"==g.gridType&&(a={templateKey:"usersTemplate",attachment:"usersTemplate.csv"}),b.post(d.reports.apis.template,a).then(function(b,c){if(g.showLoading=!1,"failure"==b.status)g.showAlert("danger","Unable to download template, please try again");else{g.showAlert("success","Template downloaded successfully");var d=document.createElement("a");d.setAttribute("href","data:text/csv;charset=utf-8,"+b.data),d.setAttribute("download",a.attachment),d.style.display="none",document.body.appendChild(d),d.click(),document.body.removeChild(d)}},function(a){g.showLoading=!1,g.showAlert("danger","Unable to download template, please try again")})},this.showAlert=function(a,b){e.hide(),this.message={type:a,content:b},this.hasAlert=!0},this.closeAlert=function(){this.hasAlert=!1}}]}),agGrid.initialiseAgGridWithAngular1(angular),angular.module("Identity").component("scriptrIdentityGrid",{bindings:{onLoad:"&onLoad",gridDataIdentifierProperty:"@",columnsDefinition:"<columnsDefinition",rowHeight:"<?",enableServerSideSorting:"<?",enableServerSideFilter:"<?",refreshOnEdit:"<?",enableColResize:"<?",pagination:"@",enableDeleteRow:"<?",enableAddRow:"<?",cellEditable:"<?",enableClientSideSorting:"<?",api:"@",onInsertRowScript:"@",onDeleteRowScript:"@",transport:"@",enableClientSideFilter:"<?",rowModelType:"@",rowModelSelection:"@",suppressRowClickSelection:"<?",suppressCellSelection:"<?",rowDeselection:"<?",onSelectionChanged:"&?",rowData:"<?",suppressFilter:"<?",gridHeight:"@",paginationPageSize:"<?",paginationOverflowSize:"<?",maxConcurrentDatasourceRequests:"<?",paginationInitialRowCount:"<?",maxPagesInCache:"<?",apiParams:"<?",deleteParams:"<?",addParams:"<?",editParams:"<?",onFormatData:"&",onCellValueChanged:"&",onCellClicked:"&",msgTag:"@",class:"@",defaultCellRenderer:"&",onGridReady:"&",useWindowParams:"@",onRowDoubleClicked:"&",sizeColumnsToFit:"<?",gridEventsId:"@",removeRowConfig:"<?",saveRowConfig:"<?",customNoRowsLabel:"@"},templateUrl:"/identity/view/javascript/components/grid/grid.html",
controller:["$scope","$window","$uibModal","$timeout","identityForms","wsClient","dataStore","identityFactory","$routeParams","httpClient","$route","$timeout","$q","identityConfig","$loadingOverlay",function(a,b,c,d,e,f,h,i,j,k,l,d,m,n,o){var q=this;q.broadcastData=null,this.identityForms=e,this.dataSource={getRows:function(a){if(null!=q.broadcastData){if(null!=q.broadcastData.api)var b=q.broadcastData.api;else var b=q.api;if(null!=q.broadcastData.params&&(q.apiParams=q.broadcastData.params),null!=q.broadcastData.transport)var c=q.broadcastData.transport;else var c=q.transport}else var b=q.api,c=q.transport;var d=q.buildParams(a),e=null;"function"==typeof q.onFormatData()&&(e=function(a){return q.onFormatData()(a)}),h.getGridData(b,d,c,e).then(function(b,c){if(b&&b.documents){var d=b.documents,e=parseInt(b.count),f=q.cleanRows(d);if(a.successCallback(f,e),q.sizeColumnsToFit&&q.gridOptions.api.sizeColumnsToFit(),q.gridOptions.api.doLayout(),null==f||0==f.length){q.gridOptions.api.showNoRowsOverlay();angular.element(document.querySelector("#btNext")).attr("disabled","true"),0==e&&(angular.element(".ag-paging-page-summary-panel > span[ref=lbTotal]")[0].innerHTML=1)}else q.gridOptions.api.hideOverlay()}else a.failCallback(),q.gridOptions.api.showNoRowsOverlay()},function(a){console.log("reject",a)})}},this.$onDestroy=function(){q.msgTag&&f.unsubscribe(q.msgTag,null,a.$id)},this.cleanRows=function(a){Array.isArray(a)||(a=[a]);for(var b=!1,c=0;c<a.length;c++)for(row in a[c])if("key"!=row){b=!1;for(var d=0;d<q.gridOptions.columnDefs.length;d++)if(row==q.gridOptions.columnDefs[d].field){b=!0;break}b||delete a[c][row]}return a},this._createNewDatasource=function(){this.gridOptions.api.setDatasource(this.dataSource)},this.$onInit=function(){this._dataIdentifierProperty=this.gridDataIdentifierProperty?this.gridDataIdentifierProperty:"key",this.useWindowParams=this.useWindowParams?this.useWindowParams:"true",this.noRowsLabel=this.customNoRowsLabel?this.customNoRowsLabel:"No Results To Show",this.sizeColumnsToFit=void 0===this.sizeColumnsToFit||this.sizeColumnsToFit,this.gridOptions={angularCompileRows:!0,domLayout:"autoHeight",rowHeight:this.rowHeight?this.rowHeight:25,enableSorting:void 0===this.enableClientSideSorting||this.enableClientSideSorting,enableServerSideSorting:void 0===this.enableServerSideSorting||this.enableServerSideSorting,enableServerSideFilter:void 0===this.enableServerSideFilter||this.enableServerSideFilter,enableColResize:void 0!==this.enableColResize&&this.enableColResize,enableFilter:!0,columnDefs:this.columnsDefinition,pagination:void 0!==this.pagination&&this.pagination,cacheBlockSize:this.paginationPageSize?this.paginationPageSize:50,rowData:this.rowData?this.rowData:null,rowModelType:"infinite",rowSelection:this.rowModelSelection?this.rowModelSelection:"multiple",suppressRowClickSelection:!this.suppressRowClickSelection||this.suppressRowClickSelection,suppressCellSelection:!this.suppressCellSelection||this.suppressCellSelection,paginationPageSize:this.paginationPageSize?this.paginationPageSize:50,overlayNoRowsTemplate:'<span class="ag-overlay-no-rows-center">'+this.noRowsLabel+"</span>",overlayLoadingTemplate:'<span class="ag-overlay-loading-center"><i class="fa fa-spinner fa-spin fa-fw fa-2x"></i>Loading...</span>',defaultColDef:{filter:!1,filterParams:{apply:!1},suppressFilter:void 0===this.suppressFilter||this.suppressFilter,editable:void 0===this.cellEditable||this.cellEditable,cellRenderer:"function"==typeof this.defaultCellRenderer()?this.defaultCellRenderer():null},onSelectionChanged:function(){if(null!=q.onSelectionChanged&&"function"==typeof q.onSelectionChanged())return q.onSelectionChanged()(q.gridOptions,q.gridApi)},onCellClicked:function(a){if(null!=q.onCellClicked&&"function"==typeof q.onCellClicked())return q.onCellClicked()(a,q.gridOptions,q.gridApi)},onCellValueChanged:function(a){},onRowValueChanged:function(a){},onGridReady:function(a){if(console.log("the grid is now ready"),d(function(){q.gridOptions.api=a.api,q.gridApi=a.api},3e3),"function"==typeof q.onGridReady()&&q.onGridReady()(q),a.api.filterManager.availableFilters.text.CONTAINS="startsWith",void 0===q.rowData||null==q.rowData||q.rowData&&0==q.rowData.length?q.api?q._createNewDatasource():a.api.setRowData([]):q.sizeColumnsToFit&&a.api.sizeColumnsToFit(),this.columnsDefinition)for(var b=0;b<this.columnsDefinition.length;b++)this.columnsDefinition[b].hasOwnProperty("type")&&"numeric"==this.columnsDefinition[b].type&&(this.columnsDefinition[b].filter="number")},onGridSizeChanged:function(a){q.sizeColumnsToFit&&q.gridOptions.api.sizeColumnsToFit()}},null!=q.onRowDoubleClicked&&"function"==typeof q.onRowDoubleClicked()&&(q.gridOptions.onRowDoubleClicked=function(a){return q.onRowDoubleClicked()(a)}),this.style={height:"100%",width:"100%"},this.refreshOnEdit=void 0!==this.refreshOnEdit&&this.refreshOnEdit,this.transport=this.transport?this.transport:"wss",this.disableDeleteRow=1!=this.enableDeleteRow,this.disableAddRow=1!=this.enableAddRow,this.mode="infinite"==this.gridOptions.rowModelType?"infinite":"normal",q.msgTag&&h.subscribe(this.onServerCall,q.msgTag,a),a.$on("updateGridData-"+q.gridEventsId,function(a,b){q.broadcastData=b,q._createNewDatasource()}),a.$on("showGridAlert-"+q.gridEventsId,function(a,b){q.broadcastData=b,q.showAlert(q.broadcastData.type,q.broadcastData.content)})},this.closeAlert=function(){this.show=!1},this.showAlert=function(a,b){o.hide(),q.message={type:a,content:b},q.showError=!0,d(function(){q.showError=!1},5e3)},this._saveData=function(a){if(a.data&&a.data[q._dataIdentifierProperty]){var b=a.data;if(b.action="edit",this.editParams)for(var c in this.editParams)b[c]=this.editParams[c];h.gridHelper(q.api,b).then(function(a,b){q.gridOptions.api.hideOverlay(),!a||"success"!=a.result&&"success"!=a.status?(q.undoChanges(),a&&a.errorDetail?q.showAlert("danger",a.errorDetail):q.showAlert("danger","An error has occurred. Please try again later.")):q.refreshOnEdit&&q.onServerCall(a)},function(a){q.gridOptions.api.hideOverlay(),console.log("reject",a),q.showAlert("danger","An error has occurred. Please try again later.")})}else{var b=a.data;if(b.action="add",this.addParams)for(var c in this.addParams)b[c]=this.addParams[c];h.gridHelper(q.api,a.data).then(function(a,b){q.gridOptions.api.hideOverlay(),!a||"success"!=a.result&&"success"!=a.status?(q.undoChanges(),a&&a.errorDetail?q.showAlert("danger",a.errorDetail):q.showAlert("danger","An error has occurred. Please try again later.")):q.refreshOnEdit&&q.onServerCall(a)},function(a){q.gridOptions.api.hideOverlay(),console.log("reject",a),g,q.showAlert("danger","An error has occurred. Please try again later.")})}},this.onAddRow=function(){q.loadOverlay(null,this.saveRowConfig.schemaFormDefinition,this.saveRowConfig.api)},this.loadOverlay=function(b,d,e){var f=angular.copy(d);f.title="Add "+f.title;var g={label:f.title,buttons:{save:{label:"Save"},cancel:{label:"Cancel"}},schema:angular.copy(f.schema),form:angular.copy(f.form),options:{}},h=this;c.open({animation:!0,component:"formOverlay",size:"lg",scope:a,resolve:{widget:function(){return g}}}).result.then(function(a){if("cancel"!=a){var b=function(a){if("group"==h.gridEventsId)null!=a.scriptHandleId&&""!=a.scriptHandleId?(o.show('<i class="fa fa-spinner fa-spin fa-1x"></i>&nbsp;<b>Saving group and updating devices...</b>'),i.getJobStatus(e,{scriptHandleId:a.scriptHandleId},30,function(a){a&&"success"==a?(h._createNewDatasource(),h.showAlert("success","Successfully saved group and updated devices")):h.showAlert("warning",a)},function(a){h.showAlert("warning","Successfully saved group. Error when updating devices")})):(h._createNewDatasource(),h.showAlert("success","Group saved successfully"));else{var b=h.gridEventsId.charAt(0).toUpperCase()+h.gridEventsId.substring(1);h._createNewDatasource(),h.showAlert("success",b+" saved successfully")}},c=function(a){var b="Unknown error";a.data&&a.data.metadata&&a.data.metadata.description&&a.data.metadata.description.en?b=a.data.metadata.description.en:a.errorDetail&&(b=a.errorDetail),h.showAlert("danger","Could not save "+h.gridEventsId+": "+b)};h.callBackendApiPost(e,a,b,c)}},function(){console.info("modal-component for widget update dismissed at: "+new Date)})},this.callBackendApiPost=function(a,b,c,d){console.log("POST calling backend api <"+a+"> with params "+JSON.stringify(b)),q._callBackendApi(a,b,"P",c,d)},this._callBackendApi=function(a,b,c,d,e){var f=k.post;"G"==c&&(f=k.get),f(a,b).then(function(a,b){console.log(a),a&&a.status&&"failure"==a.status?"function"==typeof e&&e(a):"function"==typeof d&&d(a)},function(a){console.log(a),"function"==typeof e&&e(a)})},this.openConfirmationPopUp=function(){if(q.gridOptions.api.getSelectedNodes().length>0){c.open({animation:!0,component:"deleteConfirmationOverlay",size:"lg",scope:a,resolve:{grid:function(){return q}}})}else q.showAlert("danger","No row(s) selected")},this.confirmRefreshTokensPopUp=function(){if(q.gridOptions.api.getSelectedNodes().length>0){c.open({animation:!0,component:"confirmRefreshTokenPopup",size:"lg",scope:a,resolve:{grid:function(){return q}}})}else q.showAlert("danger","No device(s) selected")},this.refreshTokens=function(){for(var a=q.gridOptions.api.getSelectedNodes(),b=[],c=0;c<a.length;c++)b.push(a[c].data[q._dataIdentifierProperty]);if(b.length>0){var d={id:b};k.post(n.device.apis.generate,d).then(function(a,b){null!=a.scriptHandleId&&""!=a.scriptHandleId?(o.show('<i class="fa fa-spinner fa-spin fa-1x"></i>&nbsp;<b>Refreshing Token(s)...</b>'),i.getJobStatus(n.device.apis.generate,{scriptHandleId:a.scriptHandleId},30,function(b){if(o.hide(),q.showTokenButtons=!0,b.status&&"failure"==b.status){return b.errorDetail&&(b=a.errorDetail),void q.showAlert("danger","Unable to refresh token(s), please try again later.")}q.token=b.token?b.token:"N/A",q._createNewDatasource(),q.gridOptions.api.deselectAll(),q.showAlert("success","Token(s) refreshed successfully")},function(a){q.showTokenButtons=!0;a.data&&a.data.metadata&&a.data.metadata.description&&a.data.metadata.description.en?a.data.metadata.description.en:a.errorDetail&&a.errorDetail,q.showAlert("danger","Unable to refresh token(s), please try again later.")})):q.showAlert("danger","Unable to refresh token(s), please try again later.")},function(a){q.showAlert("danger","Unable to refresh token(s), please try again later.")})}else q.showAlert("danger","No device(s) selected")},this.exportData=function(){o.show('<i class="fa fa-spinner fa-spin fa-1x"></i>&nbsp;<b>Exporting file, please wait...</b>');var a={gridType:q.gridEventsId,queryFilter:q.serverFilterText};k.post(n.reports.apis.export,a).then(function(b,c){"failure"==b.status?q.showAlert("danger","Unable to export, please try again"):i.getJobStatus(n.reports.apis.export,{scriptHandleId:b.scriptHandleId},30,function(b){a.docKey=b,k.get(n.reports.apis.getCSV,a).then(function(a,b){q.showAlert("success","Data exported successfully");var c=document.createElement("a");c.setAttribute("href","data:text/csv;charset=utf-8,"+a.data),c.setAttribute("download",q.gridEventsId+"s.csv"),c.style.display="none",document.body.appendChild(c),c.click(),document.body.removeChild(c)},function(a){q.showAlert("danger","Unable to export, please try again")})},function(a){q.showAlert("danger","Unable to export, please try again")})},function(a){q.showAlert("danger","Unable to export, please try again")})},this.loadImportOverlay=function(){var b=angular.copy(this.identityForms.uploaderForm),d=angular.copy(b.form),e=this,f={label:b.title,buttons:{save:{label:"Save"},cancel:{label:"Cancel"}},schema:angular.copy(b.schema),form:d,model:{},parent:e};c.open({animation:!0,component:"uploadFileComponent",size:"lg",scope:a,resolve:{widget:function(){return f}}}).result.then(function(a){},function(){console.info("modal-component for widget update dismissed at: "+new Date)})},this.onRemoveRow=function(a){if("infinite"==q.gridOptions.rowModelType)if(q.removeRowConfig&&q.removeRowConfig.api){o.show('<i class="fa fa-spinner fa-spin fa-1x"></i>&nbsp;<b>Deleting row(s)...</b>');for(var b=q.removeRowConfig.api,c=q.gridOptions.api.getSelectedNodes(),d=[],e=0;e<c.length;e++)d.push(c[e].data[q._dataIdentifierProperty]);if(d.length>0){var f={};q.removeRowConfig.queryParam?f[q.removeRowConfig.queryParam]=d:f[q._dataIdentifierProperty]=d,f.module=q.gridEventsId,h.postGridHelper(b,f).then(function(a,c){d.length>1?"failure"==a.status?q.showAlert("danger","Unable to delete row(s), please try again"):i.getJobStatus(b,{scriptHandleId:a.scriptHandleId},30,function(a){q.gridOptions.api.hideOverlay(),!a||"success"!=a.result&&"success"!=a.status?a&&a.errorDetail?q.showAlert("danger",a.errorDetail):q.showAlert("danger","Unable to delete row(s), please try again"):(q.showAlert("success","Row(s) deleted successfully"),q.onServerCall(),q.gridOptions.api.deselectAll())},function(a){q.gridOptions.api.hideOverlay(),console.log("failure",a),q.showAlert("danger","Unable to delete row(s), please try again")}):(q.gridOptions.api.hideOverlay(),!a||"success"!=a.result&&"success"!=a.status?a&&a.errorDetail?q.showAlert("danger",a.errorDetail):q.showAlert("danger","Unable to delete row(s), please try again"):(q.showAlert("success","Row(s) deleted successfully"),q.onServerCall(),q.gridOptions.api.deselectAll()))},function(a){q.gridOptions.api.hideOverlay(),console.log("reject",a),q.showAlert("danger","An error has occurred. Please try again later.")})}}else q.showAlert("danger","No script defined for delete row");else{var c=q.gridOptions.api.getSelectedNodes();q.gridOptions.api.removeItems(c)}},this.onServerCall=function(a){q.gridOptions.api.refreshInfiniteCache()},this.undoChanges=function(a){if(q.oldEditedValue){q.gridOptions.api.forEachNode(function(a){a.childIndex!=q.editedChildIndex&&a.id!=q.editedChildIndex||a.setSelected(!0,!0)});q.gridOptions.api.getSelectedNodes()[0].data[q.editedColumn]=q.oldEditedValue,q.gridOptions.api.refreshView()}else q.gridOptions.api.refreshInfiniteCache()},this.onFilterChanged=function(){this.gridOptions.enableServerSideFilter=!1,this.gridOptions.api.setQuickFilter(this.quickFilterValue),this.gridOptions.enableServerSideFilter=!0},this.onServerFilterChanged=function(){null==q.timeoutId&&(q.timeoutId=d(function(){},1e3).then(function(){q.timeoutId=null,q._createNewDatasource()}))},this.buildParams=function(a){var b=q.serverFilterText,c=null,d=a.endRow/this.gridOptions.paginationPageSize;if(a.sortModel&&a.sortModel.length>0){var e=a.sortModel[0].sort,f=a.sortModel[0].colId;c=this.gridOptions.api.getColumnDef(f).type?this.gridOptions.api.getColumnDef(f).type:null}if(a.filterModel)for(p in a.filterModel){b=a.filterModel[p].filter;var g=a.filterModel[p].type,h=p;c=this.gridOptions.api.getColumnDef(h).type?this.gridOptions.api.getColumnDef(h).type:null}var i={resultsPerPage:this.gridOptions.paginationPageSize,pageNumber:d};if(f&&(i.sortingColumnName=f),h&&(i.filterColumnName=h),e&&(i.sort=e),c&&(i.sortType=c),b&&(i.queryFilter=b),g&&(i.queryType=g),i.startRow=a.startRow,i.endRow=a.endRow,this.apiParams)for(var k in this.apiParams)i[k]=this.apiParams[k];return q.useWindowParams&&"true"==q.useWindowParams&&(i=angular.merge(i,j)),i}}]}),angular.module("Identity").service("dataStore",["httpClient","wsClient","$q",function(a,b,c){this.subscribe=function(a,c,d){b.onReady.then(function(){b.subscribe(c,a.bind(self),d.$id)})},this.gridHelper=function(b,d){var e=c.defer();return a.get(b,d).then(function(a,b){e.resolve(a,b)},function(a){e.reject(a)}),e.promise},this.postGridHelper=function(b,d){var e=c.defer();return a.post(b,d).then(function(a,b){e.resolve(a,b),console.log(a)},function(a){e.reject(a),console.log(a)}),e.promise},this.getGridData=function(d,e,f,g){var h=c.defer();return"https"==f?(a.get(d,e).then(function(a,b){if(g&&(a=g(a)),a&&a.documents){var a={documents:a.documents,count:a.count};h.resolve(a,b)}else h.resolve(null,b)},function(a){h.resolve(null),h.reject(a)}),h.promise):"wss"==f?d&&void 0!==d?(b.onReady.then(function(){b.call(d,e,"grid").then(function(a,b){if(g&&(a=g(a)),a&&a.documents){var a={documents:a.documents,count:a.count};h.resolve(a,b)}else h.resolve(null,b)},function(a){h.resolve(null),h.reject(a)})}),h.promise):(b.onReady.then(function(){b.publish(e,"publish").then(function(a,b){if(a&&a.documents){var a={documents:a.documents,count:a.count};h.resolve(a,b)}else h.resolve(null,b)},function(a){h.resolve(null),h.reject(a)})}),h.promise):void 0}}]),angular.module("Identity").component("deleteConfirmationOverlay",{bindings:{resolve:"<",close:"&",dismiss:"&"},templateUrl:"/identity/view/javascript/components/grid/popup.html",controller:["$scope",function(a){this.$onInit=function(){this.title="Delete",this.bodyMessage="Are you sure you want to delete the selected row(s)?",this.onSubmit=function(){this.resolve.grid.onRemoveRow(),this.close({$value:!0})},this.onCancel=function(){this.dismiss({$value:!1})}}}]}),angular.module("Identity").component("confirmRefreshTokenPopup",{bindings:{resolve:"<",close:"&",dismiss:"&"},templateUrl:"/identity/view/javascript/components/grid/popup.html",controller:["$scope",function(a){this.$onInit=function(){this.title="Generate/Regenerate Token(s)",this.bodyMessage="Are you sure you want to generate/regenerate the tokens of the selected row(s)?",this.onSubmit=function(){this.resolve.grid.refreshTokens(),this.close({$value:!0})},this.onCancel=function(){this.dismiss({$value:!1})}}}]}),angular.module("Identity").factory("identityFactory",["httpClient",function(a){var b={};return b.getJobStatus=function(c,d,e,f,g){e>0?(e-=1,a.get(c,d).then(function(a,h){if(console.dir(a),"complete"==a.jobStatus){var i=JSON.parse(a.jobResult);if("success"==i.resultJSON.response.metadata.status)return void f(i.resultJSON.response.result);g("An error has occurred. Please try again later.")}setTimeout(b.getJobStatus,1e3,c,d,e,f,g)},function(a){g(a)})):g("TIME_OUT")},b}]),angular.module("Identity").constant("identityForms",{group:{title:"Group",form:[{type:"section",htmlClass:"row",items:[{type:"section",htmlClass:"col-xs-6",items:[{key:"name",validationMessage:{201:"Name is too long ({{viewValue.length}} chars), maximum allowed is {{schema.maxLength}}."}}]}]},{type:"section",htmlClass:"row",items:[{key:"devices",type:"uiselectmultiple",htmlClass:"col-xs-12",placeholder:"Select Devices",options:{multiple:!0,closeOnSelect:!0,httpGet:{url:"identity/api/devices/listDevices",parameter:'{"count": false, "fields": "id,name"}'},map:{valueProperty:"id",nameProperty:"name"}}}]}],schema:{type:"object",title:"groupSchema",properties:{name:{title:"Group Name",type:"string",maxLength:116},devices:{type:"array",title:"Devices",description:"Select your group devices",items:{type:"object"}}},required:["name"]}},device:{title:"Device",form:[{type:"section",htmlClass:"row",items:[{type:"section",htmlClass:"col-xs-12 col-sm-6",items:[{key:"name",validationMessage:{201:"Name is too long ({{viewValue.length}} chars), maximum allowed is {{schema.maxLength}}."}}]},{type:"section",htmlClass:"col-xs-12 col-sm-6",items:[{key:"id",validationMessage:{201:"ID is too long ({{viewValue.length}} chars), maximum allowed is {{schema.maxLength}}."}}]}]},{type:"section",htmlClass:"row",items:[{type:"section",htmlClass:"col-xs-12 col-sm-6",items:[{key:"password",type:"password",ngModelOptions:{allowInvalid:!0},onChange:function(a,b,c,d){console.log(c),a!=c.confirmPassword?d.$root.$broadcast("schemaForm.error.newPassword","doNotMatch",!1):(d.$root.$broadcast("schemaForm.error.newPassword","doNotMatch",!0),d.$root.$broadcast("schemaForm.error.confirmPassword","doNotMatch",!0))}}]},{type:"section",htmlClass:"col-xs-12 col-sm-6",items:[{key:"confirmPassword",type:"password",condition:"model.password",required:!0,ngModelOptions:{allowInvalid:!0},onChange:function(a,b,c,d){console.log(c),a!=c.password?d.$root.$broadcast("schemaForm.error.confirmPassword","doNotMatch",!1):(d.$root.$broadcast("schemaForm.error.newPassword","doNotMatch",!0),d.$root.$broadcast("schemaForm.error.confirmPassword","doNotMatch",!0))}},{key:"confirmPassword",type:"password",condition:"!model.password",ngModelOptions:{allowInvalid:!0}}]}]},{type:"section",htmlClass:"row",items:[{type:"section",htmlClass:"col-xs-12",items:[{key:"description",validationMessage:{201:"Description is too long ({{viewValue.length}} chars), maximum allowed is {{schema.maxLength}}."}}]}]},{type:"section",htmlClass:"row",items:[{type:"section",htmlClass:"col-xs-12",items:[{type:"radios-inline",title:"Status",key:"isSuspended",titleMap:[{value:"false",name:"Active"},{value:"true",name:"Suspended"}]}]}]},{type:"section",htmlClass:"row",items:[{type:"section",htmlClass:"col-xs-12",items:[{type:"uiselectmultiple",placeholder:"Select Group",key:"groups",options:{httpGet:{url:"identity/api/groups/listGroups",parameter:'{"count": false}'},map:{valueProperty:"name",nameProperty:"name"}}}]}]},{key:"_oldDeviceAttrs",type:"hidden",notitle:!0,onFieldLoad:function(a,b,c){c._oldDeviceAttrs=_.pluck(c.deviceAttrs,"name")}},{type:"section",htmlClass:"",items:[{key:"deviceAttrs",title:"Device Attributes",items:[{type:"section",htmlClass:"row",items:[{type:"section",htmlClass:"col-xs-6 col-sm-3",items:[{key:"deviceAttrs[].name",title:"name"}]},{type:"section",htmlClass:"col-xs-6 col-sm-3",items:[{type:"select",key:"deviceAttrs[].type",placeholder:"select type",titleMap:[{value:"string",name:"string"},{value:"numeric",name:"numeric"},{value:"date",name:"date"},{value:"text",name:"text"},{value:"geospatial",name:"geospatial"}],title:"type"}]},{type:"section",htmlClass:"col-xs-6 col-sm-3",items:[{key:"deviceAttrs[].value",title:"value"}]}]}]}]}],schema:{type:"object",title:"deviceSchema",properties:{name:{title:"Device",type:"string",maxLength:1024},id:{title:"Device ID",type:"string",maxLength:117},password:{title:"Password",type:"string",validationMessage:{doNotMatch:"Passwords do not match"},"x-schema-form":{type:"password"}},confirmPassword:{title:"Confirm Password",type:"string",validationMessage:{doNotMatch:"Passwords do not match"},"x-schema-form":{type:"password"}},description:{title:"Description",type:"string",maxLength:1024,"x-schema-form":{type:"textarea",placeholder:"Description for this device"}},groups:{type:"array",title:"Groups",items:{type:"object"}},isSuspended:{title:"Status",type:"string",default:"false"},deviceAttrs:{title:"Device Attributes",type:"array",items:{type:"object",properties:{name:{title:"Name",type:"string"},type:{title:"type",type:"string",placeholder:"select type"},value:{title:"Value",type:"string"}}}},_oldDeviceAttrs:{type:"string"}},required:["name","id","password","confirmPassword"]}},user:{title:"User",form:[{type:"section",htmlClass:"row",items:[{type:"section",htmlClass:"col-xs-12 col-sm-6",items:[{key:"name",validationMessage:{201:"Name is too long ({{viewValue.length}} chars), maximum allowed is {{schema.maxLength}}."}}]},{type:"section",htmlClass:"col-xs-12 col-sm-6",items:[{key:"id",validationMessage:{201:"login username is too long ({{viewValue.length}} chars), maximum allowed is {{schema.maxLength}}."}}]}]},{type:"section",htmlClass:"row",items:[{type:"section",htmlClass:"col-xs-12 col-sm-6",items:[{key:"password",type:"password",ngModelOptions:{allowInvalid:!0},onChange:function(a,b,c,d){console.log(c),a!=c.confirmPassword?d.$root.$broadcast("schemaForm.error.newPassword","doNotMatch",!1):(d.$root.$broadcast("schemaForm.error.newPassword","doNotMatch",!0),d.$root.$broadcast("schemaForm.error.confirmPassword","doNotMatch",!0))}}]},{type:"section",htmlClass:"col-xs-12 col-sm-6",items:[{key:"confirmPassword",type:"password",condition:"model.password",required:!0,ngModelOptions:{allowInvalid:!0},onChange:function(a,b,c,d){console.log(c),a!=c.password?d.$root.$broadcast("schemaForm.error.confirmPassword","doNotMatch",!1):(d.$root.$broadcast("schemaForm.error.newPassword","doNotMatch",!0),d.$root.$broadcast("schemaForm.error.confirmPassword","doNotMatch",!0))}},{key:"confirmPassword",type:"password",condition:"!model.password",ngModelOptions:{allowInvalid:!0},onChange:function(a,b,c,d){console.log(c),a!=c.password?d.$root.$broadcast("schemaForm.error.confirmPassword","doNotMatch",!1):(d.$root.$broadcast("schemaForm.error.newPassword","doNotMatch",!0),d.$root.$broadcast("schemaForm.error.confirmPassword","doNotMatch",!0))}}]}]},{type:"section",htmlClass:"row",items:[{type:"section",htmlClass:"col-xs-12",items:[{key:"email",validationMessage:{202:"Invalid email address"}}]}]},{type:"section",htmlClass:"row",items:[{type:"section",htmlClass:"col-xs-12",items:[{type:"radios-inline",title:"Status",key:"isSuspended",titleMap:[{value:"false",name:"Active"},{value:"true",name:"Suspended"}]}]}]},{type:"section",htmlClass:"row",items:[{type:"section",htmlClass:"col-xs-12",items:[{type:"uiselectmultiple",placeholder:"Select Group",key:"groups",options:{httpGet:{url:"identity/api/groups/listGroups",parameter:'{"count": false}'},map:{valueProperty:"name",nameProperty:"name"}}}]}]},{key:"_oldUserAttrs",type:"hidden",notitle:!0,onFieldLoad:function(a,b,c){c._oldUserAttrs=_.pluck(c.userAttrs,"name")}},{type:"section",htmlClass:"",items:[{key:"userAttrs",title:"User Attributes",items:[{type:"section",htmlClass:"row",items:[{type:"section",htmlClass:"col-xs-6 col-sm-3",items:[{key:"userAttrs[].name",title:"name"}]},{type:"section",htmlClass:"col-xs-6 col-sm-3",items:[{type:"select",key:"userAttrs[].type",placeholder:"select type",titleMap:[{value:"string",name:"string"},{value:"numeric",name:"numeric"},{value:"date",name:"date"},{value:"text",name:"text"},{value:"geospatial",name:"geospatial"}],title:"type"}]},{type:"section",htmlClass:"col-xs-6 col-sm-3",items:[{key:"userAttrs[].value",title:"value"}]}]}]}]}],schema:{type:"object",title:"userSchema",properties:{name:{title:"User Name",type:"string",maxLength:1024},id:{title:"Login",type:"string",maxLength:1024},password:{title:"Password",type:"string",validationMessage:{doNotMatch:"Passwords do not match"},"x-schema-form":{type:"password"}},confirmPassword:{title:"Confirm Password",type:"string",validationMessage:{doNotMatch:"Passwords do not match"},"x-schema-form":{type:"password"}},email:{title:"Email Address",type:"string",pattern:"^[_a-zA-Z0-9-]+(\\.[_a-zA-Z0-9-]+)*@[a-zA-Z0-9-]+(\\.[a-zA-Z0-9-]+)*(\\.[a-zA-Z]{2,})$"},groups:{type:"array",title:"Groups",items:{type:"object"}},isSuspended:{title:"Status",type:"string",default:"false"},userAttrs:{title:"User Attributes",type:"array",items:{type:"object",properties:{name:{title:"Name",type:"string"},type:{title:"type",type:"string",placeholder:"select type"},value:{title:"Value",type:"string"}}}},_oldUserAttrs:{type:"string"}},required:["name","id","password","confirmPassword"]}},uploaderForm:{form:[{type:"section",items:[{type:"section",items:[{key:"csvFile",type:"nwpFileUpload",showProgress:!1,simpleImageUpload:!1,i18n:{add:"Open file browser",preview:"Preview Upload",filename:"File Name",progress:"Progress Status",upload:"Upload",dragorclick:"Drag and drop your file here or click here",required:"Required"},notitle:!1}]}]}],schema:{type:"object",title:"Schema",properties:{csvFile:{title:"File",type:"array",format:"singlefile","x-schema-form":{type:"array"},pattern:{mimeType:".csv",validationMessage:"Wrong File Type. Allowed types "},maxSize:{maximum:"10MB",validationMessage:"File exceeded allowed size of "}}},required:["csvFile"]}}});