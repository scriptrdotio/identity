!function(a){"use strict";var b=a.module("ngLoadingOverlay",[]);b.provider("$loadingOverlayConfig",function(){var a={bg:"rgba(0, 0, 0, 0.5)",textColor:"#fff",template:"<b>Please wait</b>",zIndex:9999};this.defaultConfig=function(b,c,d,e){a.bg=c||a.bg,a.template=b||a.template,a.textColor=d||a.textColor,a.zIndex=e||a.zIndex},this.$get=function(){return{get:function(){return a}}}}),b.service("$loadingOverlay",["$compile","$rootScope","$sce","$loadingOverlayConfig",function(b,c,d,e){var f=0,g=e.get(),h=a.element('<div id="ng-loading-overlay" ng-show="show" style="display: -webkit-box; display: -moz-box; display: -ms-flexbox; display: -webkit-flex; display: flex; align-items: center; justify-content: center; position:absolute; left:0; height: 100%; width: 100%;" ng-style="{\'background\': bg, \'color\': textColor, \'top\': positionTop, \'z-index\': zIndex}"><div style="position:relative;opacity: 1;" ng-bind-html="template"></div></div>'),i=c.$new();i.show=!1,a.element(document).ready(function(){h=b(h)(i),a.element(document.body).append(h)}),this.show=function(b,c,e,h){var j=a.element(document.body);f+=1,i.template=b?d.trustAsHtml(b):d.trustAsHtml(g.template),i.bg=c||g.bg,i.textColor=e||g.textColor,i.zIndex=h||g.zIndex,i.positionTop=window.pageYOffset,console.log(i.positionTop),j.css("overflow","hidden"),i.show=!0},this.hide=function(){f&&(f-=1),f||(a.element(document.body).css("overflow","auto"),i.show=!1)}}])}(window.angular),angular.module("Identity",["agGrid","schemaForm","ui.bootstrap","ngRoute","ngAnimate","ngSanitize","ngMaterial","ngMessages","material.svgAssetsCache","angularSpectrumColorpicker","angular-underscore/filters","ui.codemirror","mgcrea.ngStrap","mgcrea.ngStrap.modal","pascalprecht.translate","ui.select","ui.highlight","mgcrea.ngStrap.select","ngSchemaFormFile","ngLoadingOverlay","WsClient","HttpClient","DataService"]),angular.module("Identity").component("scriptrIdentityMain",{bindings:{identityLayout:"@"},templateUrl:"/identity/view/javascript/components/main/identity.html",controller:["$location","$scope","$rootScope","httpClient","identityForms","$routeParams","$timeout","$mdDialog","$uibModal","$route","$loadingOverlay","identityFactory",function(a,b,c,d,e,f,g,h,i,j,k,l){var m=this;this.$onInit=function(){console.log("identityLayout: "+this.identityLayout);var a=this;a.deviceTitle="Identity Manager",a.renderGrid=!0,a.identityForms=e,a.gridId=void 0!==this.identityLayout&&null!=this.identityLayout&&""!=this.identityLayout?this.identityLayout:"device",a.identifierProperty=void 0!==this.identityLayout&&null!=this.identityLayout&&""!=this.identityLayout?identityConfig[this.identityLayout].identifierProperty:identityConfig.device.identifierProperty,a.deviceTabClass="btnSelected",a.gridAPI=void 0!==this.identityLayout&&null!=this.identityLayout&&""!=this.identityLayout?identityConfig[this.identityLayout].apis.list:identityConfig.device.apis.list,a.copyTooltip="Copy Token",angular.element(document.querySelector("body")).addClass(identityConfig.theme),a.removeDeviceConfig={api:identityConfig.device.apis.delete,queryParam:"id"},a.removeUserConfig={api:identityConfig.user.apis.delete,queryParam:"id"},a.removeGroupConfig={api:identityConfig.group.apis.delete,queryParam:"name"},a.saveDeviceConfig={api:identityConfig.device.apis.save,schemaFormDefinition:a.identityForms.device},a.saveGroupConfig={api:identityConfig.group.apis.save,schemaFormDefinition:a.identityForms.group},a.saveUserConfig={api:identityConfig.user.apis.save,schemaFormDefinition:a.identityForms.user}},m.changeTab=function(a){m.gridId=a,"group"==m.gridId?(m.deviceTabClass="",m.userTabClass="",m.groupTabClass="btnSelected",m.identifierProperty=identityConfig.group.identifierProperty,m.gridAPI=identityConfig.group.apis.list):"device"==m.gridId?(m.deviceTabClass="btnSelected",m.identifierProperty=identityConfig.device.identifierProperty,m.groupTabClass="",m.userTabClass="",m.gridAPI=identityConfig.device.apis.list):"user"==m.gridId&&(m.userTabClass="btnSelected",m.identifierProperty=identityConfig.user.identifierProperty,m.groupTabClass="",m.deviceTabClass="",m.gridAPI=identityConfig.user.apis.list)},m.groupsColDef=[{headerName:"",checkboxSelection:!0,headerCheckboxSelection:!0,width:30},{headerName:"Group Name",field:"name",cellClass:"textWrap",editable:!1,cellRenderer:function(a){return a.value?a.value.split("_")[0]:"N/A"}},{headerName:"Number of Devices",field:"count",cellClass:"textWrap",editable:!1,cellRenderer:function(a){return a.value?a.value.split("_")[0]:"N/A"}},{headerName:"",width:60,cellClass:"textWrap",editable:!1,cellRenderer:function(a){var b=document.createElement("div");return b.innerHTML='<button class="btn btn-default btn-block" tooltip-append-to-body="true" tooltip-placement="auto" uib-tooltip="View Group"><i class="glyphicon glyphicon-eye-open" aria-hidden="true"></i></button>',b.querySelectorAll(".btn")[0].addEventListener("click",function(b){k.show('<i class="fa fa-spinner fa-spin fa-1x"></i>&nbsp;<b>Fetching group...</b>'),m.getIdentity(a)}),b}},{headerName:"",width:60,cellClass:"textWrap",editable:!1,cellRenderer:function(a){var b=document.createElement("div");return b.innerHTML='<button class="btn btn-default btn-block" tooltip-append-to-body="true" tooltip-placement="auto" uib-tooltip="Edit Group"><i class="glyphicon glyphicon-edit" aria-hidden="true"></i></button>',b.querySelectorAll(".btn")[0].addEventListener("click",function(b){m.loadEditGroupOverlay(a.data,m.identityForms.group,identityConfig.group.apis.save)}),b}},{headerName:"",width:60,cellClass:"textWrap",editable:!1,cellRenderer:function(a){var b=document.createElement("div");return b.innerHTML='<button class="btn btn-default btn-block" tooltip-append-to-body="true" tooltip-placement="auto" uib-tooltip="Delete Group"><i class="glyphicon glyphicon-trash" aria-hidden="true"></i></button>',b.querySelectorAll(".btn")[0].addEventListener("click",function(b){m.showConfirmDialog(a)}),b}}],m.devicesColDef=[{headerName:"",checkboxSelection:!0,width:50,suppressSorting:!0},{headerName:"Device Name",field:"name",cellClass:"textWrap",editable:!1,cellRenderer:function(a){return a.value?a.value.split("_")[0]:"N/A"}},{headerName:"Device ID",field:"id",cellClass:"textWrap",editable:!1,cellRenderer:function(a){return a.value?a.value.split("_")[0]:"N/A"}},{headerName:"Token",field:"auth_token",cellClass:"textWrap",editable:!1,suppressSorting:!0,tooltipField:"auth_token",cellRenderer:function(a){if(a.value){var b=document.createElement("div"),c='<span tooltip-placement="auto" tooltip-append-to-body="true" uib-tooltip="'+m.copyTooltip+'" class="icon"><i class="glyphicon glyphicon-duplicate" aria-hidden="true"></i></span>',d="..."+a.value.substr(a.value.length-8,8);b.innerHTML=d+"&nbsp;&nbsp;&nbsp;"+c;return b.querySelectorAll(".icon")[0].addEventListener("click",function(b){m.copyToClipboard(a)}),b}return"N/A"}},{headerName:"Status",field:"isSuspended",cellClass:"textWrap",editable:!1,cellRenderer:function(a){var b="Active";if(null!=a.value){"true"==a.value&&(b="Suspended")}return b}},{headerName:"Last Modified",field:"lastModifiedDate",cellClass:"textWrap",editable:!1,cellRenderer:function(a){return a.value?moment(a.value).format("DD-MMM-YYYY hh:mm A"):"N/A"}},{headerName:" ",field:"value",suppressSorting:!0,cellRenderer:function(a){var b,c=document.createElement("div");return c.innerHTML='<button class="btn btn-default btn-view" tooltip-append-to-body="true" tooltip-placement="auto" uib-tooltip="View Device"><i class="glyphicon glyphicon-eye-open" aria-hidden="true"></i></button>',b=c.querySelectorAll(".btn-view")[0],b.addEventListener("click",function(){k.show('<i class="fa fa-spinner fa-spin fa-1x"></i>&nbsp;<b>Fetching device...</b>'),m.getIdentity(a)}),c},width:60},{headerName:" ",field:"value",suppressSorting:!0,cellRenderer:function(a){var b,c=document.createElement("div");return c.innerHTML='<button class="btn btn-default btn-edit" tooltip-append-to-body="true" tooltip-placement="auto" uib-tooltip="Edit Device"><i class="glyphicon glyphicon-edit" aria-hidden="true"></i></button>',b=c.querySelectorAll(".btn-edit")[0],b.addEventListener("click",function(b){m.loadEditIdentityOverlay.bind(m,a.data)()}),c},width:60},{headerName:" ",field:"value",suppressSorting:!0,cellRenderer:function(a){var b,c=document.createElement("div");return c.innerHTML='<button class="btn btn-default btn-delete" tooltip-append-to-body="true" tooltip-placement="auto" uib-tooltip="Delete Device"><i class="glyphicon glyphicon-trash" aria-hidden="true"></i></button>',b=c.querySelectorAll(".btn-delete")[0],b.addEventListener("click",function(){m.showConfirmDialog(a)}),c},width:60},{hide:!0,field:"description"}],m.usersColDef=[{headerName:"",checkboxSelection:!0,headerCheckboxSelection:!0,width:30},{headerName:"Login",field:"id",cellClass:"textWrap",editable:!1,cellRenderer:function(a){return a.value?a.value.split("_")[0]:"N/A"}},{headerName:"User Name",field:"name",cellClass:"textWrap",editable:!1,cellRenderer:function(a){return a.value?a.value.split("_")[0]:"N/A"}},{headerName:"Email",field:"email",cellClass:"textWrap",editable:!1,cellRenderer:function(a){return a.value?a.value.split("_")[0]:"N/A"}},{headerName:"Status",field:"isSuspended",cellClass:"textWrap",editable:!1,cellRenderer:function(a){var b="Active";if(null!=a.value){"true"==a.value&&(b="Suspended")}return b}},{headerName:"Last Modified",field:"lastModifiedDate",cellClass:"textWrap",editable:!1,cellRenderer:function(a){return a.value?moment(a.value).format("DD-MMM-YYYY hh:mm A"):"N/A"}},{headerName:"",width:60,cellClass:"textWrap",editable:!1,cellRenderer:function(a){var b=document.createElement("div");return b.innerHTML='<button class="btn btn-default btn-block" tooltip-append-to-body="true" tooltip-placement="auto" uib-tooltip="View User"><i class="glyphicon glyphicon-eye-open" aria-hidden="true"></i></button>',b.querySelectorAll(".btn")[0].addEventListener("click",function(b){k.show('<i class="fa fa-spinner fa-spin fa-1x"></i>&nbsp;<b>Fetching user...</b>'),m.getIdentity(a)}),b}},{headerName:"",width:60,cellClass:"textWrap",editable:!1,cellRenderer:function(a){var b=document.createElement("div");return b.innerHTML='<button class="btn btn-default btn-block" tooltip-append-to-body="true" tooltip-placement="auto" uib-tooltip="Edit User"><i class="glyphicon glyphicon-edit" aria-hidden="true"></i></button>',b.querySelectorAll(".btn")[0].addEventListener("click",function(b){m.loadEditIdentityOverlay.bind(m,a.data)()}),b}},{headerName:"",width:60,cellClass:"textWrap",editable:!1,cellRenderer:function(a){var b=document.createElement("div");return b.innerHTML='<button class="btn btn-default btn-block" tooltip-append-to-body="true" tooltip-placement="auto" uib-tooltip="Delete User"><i class="glyphicon glyphicon-trash" aria-hidden="true"></i></button>',b.querySelectorAll(".btn")[0].addEventListener("click",function(b){m.showConfirmDialog(a)}),b}}],m.getIdentity=function(a){var b,c;"device"==m.gridId||"user"==m.gridId?(c={id:a.data.id,module:m.gridId},b=identityConfig[m.gridId].apis.get):"group"==m.gridId&&(c={name:a.data.name},b=identityConfig.group.apis.getGroupDevicesToView),d.post(b,c).then(function(b,c){if(b.status&&"failure"==b.status)return k.hide(),void m.showAlert("danger","Could not fetch "+m.gridId+", please try again later");k.hide();var d="",e="",f={};"device"==m.gridId||"user"==m.gridId?(f={grid:a.api,identityData:a.data,parent:m,identityInfo:b},d="viewIdentityDialogCtrl",e="/identity/view/html/views/viewIdentity.html"):"group"==m.gridId&&(f={grid:a.api,groupData:a.data,parent:m,groupInfo:b},d="viewGroupDialogCtrl",e="/identity/view/html/views/groups/viewGroup.html"),h.show({controller:d,controllerAs:"vm",templateUrl:e,clickOutsideToClose:!0,escapeToClose:!0,locals:f,ok:"Close"})},function(a){console.dir(a);a.data&&a.data.metadata&&a.data.metadata.description&&a.data.metadata.description.en?a.data.metadata.description.en:a.errorDetail&&a.errorDetail,k.hide(),m.showAlert("danger","Could not fetch "+m.gridId+", please try again later")})},m.showAlert=function(a,c){b.$broadcast("showGridAlert-"+m.gridId,{type:a,content:c})},m.callBackendApiPost=function(a,b,c,d){console.log("POST calling backend api <"+a+"> with params "+JSON.stringify(b)),m._callBackendApi(a,b,"P",c,d)},m._callBackendApi=function(a,b,c,e,f){var g=d.post;"G"==c&&(g=d.get),g(a,b).then(function(a,b){a&&a.status&&"failure"==a.status?"function"==typeof f&&f(a):"function"==typeof e&&e(a)},function(a){"function"==typeof f&&f(a)})},m.loadEditGroupOverlay=function(a,c,e){k.show('<i class="fa fa-spinner fa-spin fa-1x"></i>&nbsp;<b>Fetching group...</b>'),d.post(identityConfig.group.apis.getGroupDevices,a).then(function(d,f){if(d.status&&"failure"==d.status){var g="Unknown error";return d.data&&d.data.metadata&&d.data.metadata.description&&d.data.metadata.description.en?g=d.data.metadata.description.en:d.errorDetail&&(g=d.errorDetail),void m.showAlert("danger","Could not fetch group: "+g)}m.closeAlert();var h=angular.copy(c);h.title="Edit "+h.title;var j={label:h.title,buttons:{save:{label:"Save"},cancel:{label:"Cancel"}},schema:angular.copy(h.schema),form:angular.copy(h.form),model:{name:a.name,devices:d.devices,originalName:a.name,originalDevices:d.devices}};k.hide(),i.open({animation:!0,component:"formOverlay",size:"lg",scope:b,resolve:{widget:function(){return j}}}).result.then(function(a){if(console.log("Model Data",a),"cancel"!=a){var c=function(a){null!=a.scriptHandleId&&""!=a.scriptHandleId?(k.show('<i class="fa fa-spinner fa-spin fa-1x"></i>&nbsp;<b>Saving group and updating devices...</b>'),l.getJobStatus(e,{scriptHandleId:a.scriptHandleId},30,function(a){a&&"success"==a?(b.$broadcast("updateGridData-"+m.gridId,{}),m.showAlert("success","Successfully saved group and updated devices")):m.showAlert("warning",a)},function(a){m.showAlert("warning","Successfully saved group. Error when updating devices")})):(b.$broadcast("updateGridData-"+m.gridId,{}),m.showAlert("success","Group saved successfully"))},d=function(a){var b="Unknown error";a.data&&a.data.metadata&&a.data.metadata.description&&a.data.metadata.description.en?b=a.data.metadata.description.en:a.errorDetail&&(b=a.errorDetail),m.showAlert("danger","Could not save group: "+b)};a.update=!0,a.originalDevices=j.model.originalDevices,a.originalName!=a.name&&(a.newName=a.name,a.name=a.originalName);var f=a.originalDevices.sort(),g=a.devices.sort();f.length==g.length&&f.every(function(a,b){return a===g[b]})&&(a.updateDevices=!1),m.callBackendApiPost(e,a,c,d)}},function(){console.info("modal-component for widget update dismissed at: "+new Date)})},function(a){if(console.dir(a),"success"==a.status)return b.$broadcast("updateGridData-"+m.gridId,{}),void m.showAlert("success","Group saved successfully");var c="Unknown error";a.data&&a.data.metadata&&a.data.metadata.description&&a.data.metadata.description.en?c=a.data.metadata.description.en:a.errorDetail&&(c=a.errorDetail),m.showAlert("danger","Could not save group, please try again later: "+c)})},m.temp=function(a,c,d){var f=this,g=e[f.gridId],h=f.gridId.charAt(0).toUpperCase()+f.gridId.substring(1);if(console.log(f),c.status&&"failure"==c.status){var j="Unknown error";return c.data&&c.data.metadata&&c.data.metadata.description&&c.data.metadata.description.en?j=c.data.metadata.description.en:c.errorDetail&&(j=c.errorDetail),void f.showAlert("danger","Could not fetch "+f.gridId+", please try again later: "+j)}var l=[];l=c.groups instanceof Array?c.groups:[c.groups];var m,n=["name","groups","creator","versionNumber","latest","lastModifiedBy","creationDate","lastModifiedDate","isSuspended","id","meta.types","workflowState"];"device"==f.gridId?(n.push("auth_token","description"),m=identityConfig.device.apis.save):"user"==f.gridId&&(n.push("email","token","login"),m=identityConfig.user.apis.save);var o=[],p=c["meta.types"];Object.keys(c).forEach(function(a){if(n.indexOf(a)<0){f.hasAttrs=!0;var b={};b.name=a,b.type=p[a],b.value=c[a],o.push(b)}}),f.closeAlert();var q=angular.copy(g);q.title="Edit "+q.title;var r=angular.copy(q.form),s=["name","id"],t=angular.copy(q.schema);t.required=s,t.properties.id.readonly=!0;var u={label:q.title,buttons:{save:{label:"Save"},cancel:{label:"Cancel"}},schema:t,form:r,model:{name:a.name,id:a.id,isSuspended:c.isSuspended,groups:l}};"device"==f.gridId?(u.model.deviceAttrs=o,u.model.description=a.description):"user"==f.gridId&&(u.model.userAttrs=o,u.model.email=a.email),k.hide();var f=this;i.open({animation:!0,component:"formOverlay",size:"lg",scope:b,resolve:{widget:function(){return u}}}).result.then(function(a){if("cancel"!=a){var c=function(a){b.$broadcast("updateGridData-"+f.gridId,{}),f.showAlert("success",h+" saved successfully")},d=function(a){var b="Unknown error";a.data&&a.data.metadata&&a.data.metadata.description&&a.data.metadata.description.en?b=a.data.metadata.description.en:a.errorDetail&&(b=a.errorDetail),f.showAlert("danger","Could not save "+f.gridId+", please try again later: "+b)};a.update=!0,f.callBackendApiPost(m,a,c,d)}},function(){console.info("modal-component for widget update dismissed at: "+new Date)})},this.loadEditIdentityOverlay=function(a){var c=this;k.show('<i class="fa fa-spinner fa-spin fa-1x"></i>&nbsp;<b>Fetching '+c.gridId+"...</b>"),d.post(identityConfig[c.gridId].apis.get,{id:a.id,module:c.gridId}).then(c.temp.bind(c,a),function(a){if("success"==a.status){b.$broadcast("updateGridData-"+c.gridId,{});var d=c.gridId.charAt(0).toUpperCase()+c.gridId.substring(1);return void c.showAlert("success",d+" saved successfully")}var e="Unknown error";a.data&&a.data.metadata&&a.data.metadata.description&&a.data.metadata.description.en?e=a.data.metadata.description.en:a.errorDetail&&(e=a.errorDetail),c.showAlert("danger","Could not save "+c.gridId+", please try again later: "+e)})},m.closeAlert=function(){this.showError=!1},m.copyToClipboard=function(a){navigator.clipboard.writeText(a.value).then(function(){console.log("Copying to clipboard was successful"),m.copyTooltip="Copied!",a.refreshCell()},function(a){console.error("Could not copy text: ",a)})},m.showConfirmDialog=function(a){h.show({controller:"confirmDeleteDialogCtrl",controllerAs:"vm",templateUrl:"/identity/view/html/views/confirmationDialog.html",clickOutsideToClose:!0,escapeToClose:!0,locals:{dataObject:a.data,grid:a.api,parent:m},ok:"Close"})}}]}),angular.module("Identity").controller("confirmDeleteDialogCtrl",["httpClient","dataObject","grid","$scope","parent","$mdDialog","$loadingOverlay",function(a,b,c,d,e,f,g){var h=this;h.parent=e,h.identifier=b[h.parent.identifierProperty],h.grid=c,h.config=identityConfig,h.deleteApi=identityConfig[h.parent.gridId].apis.delete,h.header="Confirm Delete",h.init=function(){h.promptMessage="Are you sure you want to delete '"+h.identifier+"'?"},h.deleteIdentity=function(){h.closeDialog(),g.show('<i class="fa fa-spinner fa-spin fa-1x"></i>&nbsp;<b>Deleting '+h.parent.gridId+"...</b>");var b={},c=h.parent.gridId.charAt(0).toUpperCase()+h.parent.gridId.substring(1);b[h.parent.identifierProperty]=h.identifier,b.module=h.parent.gridId,a.post(h.deleteApi,b).then(function(a,b){if(a.status&&"failure"==a.status)return void h.parent.showAlert("danger","Could not delete "+h.parent.gridId+", please try again later");h.parent.showAlert("success",c+" deleted successfully"),h.grid.refreshInfiniteCache(),h.grid.deselectAll()},function(a){if(h.grid.hideOverlay(),"success"==a.status)return h.parent.showAlert("success",c+" deleted successfully"),void h.grid.refreshInfiniteCache();a.data&&a.data.metadata&&a.data.metadata.description&&a.data.metadata.description.en?a.data.metadata.description.en:a.errorDetail&&a.errorDetail,h.parent.showAlert("danger","Could not delete "+h.parent.gridId+", please try again later")})},h.closeDialog=function(){f.hide()}}]),angular.module("Identity").controller("viewIdentityDialogCtrl",["$timeout","httpClient","identityData","grid","parent","$mdDialog","$scope","identityInfo",function(a,b,c,d,e,f,g,h){var i=this;i.identityData=c,i.identityId=c.id,i.parent=e,i.gridId=i.parent.gridId.charAt(0).toUpperCase()+i.parent.gridId.substring(1),i.grid=d,i.identityFetched=!1,i.hidePromptMessage=!1,i.showTokenButtons=!0,i.deleteApi=identityConfig[i.parent.gridId].apis.delete,i.getApi=identityConfig[i.parent.gridId].apis.get,i.copyTooltip="Copy Token",i.showActionButtons=!0,i.init=function(){i.name=h.name?h.name:"N/A",i.id=h.id?h.id:"N/A","device"==i.parent.gridId&&(i.identityNameLabel="Device Name",i.identityIdLabel="Device ID",i.description=h.description?h.description:"N/A",i.token=h.auth_token?h.auth_token:"N/A"),"user"==i.parent.gridId&&(i.identityNameLabel="User Name",i.identityIdLabel="Login",i.email=h.email?h.email:"N/A"),null!=h.groups?h.groups instanceof Array?i.groups=h.groups:i.groups=[h.groups]:i.groups=["N/A"];var a="Active";null!=h.isSuspended&&"true"==h.isSuspended&&(a="Suspended"),i.status=a,i.hasAttrs=!1;var b=["name","groups","creator","versionNumber","latest","lastModifiedBy","creationDate","lastModifiedDate","isSuspended","id","meta.types","workflowState"];"device"==i.parent.gridId?b.push("auth_token","description"):"user"==i.parent.gridId&&b.push("email","token","login");var c=[],d=h["meta.types"];Object.keys(h).forEach(function(a){if(b.indexOf(a)<0){i.hasAttrs=!0;var e={};e.name=a,e.type=d[a],e.value=h[a],c.push(e)}}),i.identityAttrs=c,i.identityFetched=!0,i.hidePromptMessage=!0},i.confirmationDeleteIdentity=function(){i.showActionButtons=!1},i.editIdentity=function(){i.closeDialog();var a=i.parent.identityForms[i.parent.gridId];i.parent.loadEditIdentityOverlay(i.identityData,a,identityConfig[i.parent.gridId].apis.save)},i.copyToken=function(){navigator.clipboard.writeText(i.token).then(function(){i.copyTooltip="Copied!"},function(a){var b="Unknown error";a.errorDetail&&(b=a.errorDetail),i.showAlert("danger","Could not copy token: "+b)})},i.resetCopyTooltip=function(){a(function(){i.copyTooltip="Copy Token"},500)},i.regenerateToken=function(){i.generateToken("regenerate")},i.generateToken=function(a){a=null!=a&&"regenerate"==a?"regenerate":"generate";var c={id:i.id,action:a};b.post(identityConfig.device.apis.generate,c).then(function(b,c){if(i.showTokenButtons=!0,b.status&&"failure"==b.status){var d="Unknown error";return b.errorDetail&&(d=b.errorDetail),void i.showAlert("danger","Failed to "+a+": "+d)}i.token=b.token?b.token:"N/A",i.grid.refreshInfiniteCache()},function(b){i.showTokenButtons=!0;var c="Unknown error";b.data&&b.data.metadata&&b.data.metadata.description&&b.data.metadata.description.en?c=b.data.metadata.description.en:b.errorDetail&&(c=b.errorDetail),i.showAlert("danger","Failed to "+a+": "+c)})},i.revokeToken=function(){var a={id:i.id};b.post(identityConfig.device.apis.revoke,a).then(function(a,b){if(i.showTokenButtons=!0,a.status&&"failure"==a.status){var c="Unknown error";return a.errorDetail&&(c=a.errorDetail),void i.showAlert("danger","Could not delete token: "+c)}i.token="N/A",i.grid.refreshInfiniteCache()},function(a){i.showTokenButtons=!0;var b="Unknown error";a.data&&a.data.metadata&&a.data.metadata.description&&a.data.metadata.description.en?b=a.data.metadata.description.en:a.errorDetail&&(b=a.errorDetail),i.showAlert("danger","Could not delete token: "+b)})},i.deleteIdentity=function(){var a={id:i.identityId,module:i.parent.gridId};b.post(i.deleteApi,a).then(function(a,b){if(a.status&&"failure"==a.status){i.showActionButtons=!0;var c="Unknown error";return a.errorDetail&&(c=a.errorDetail),void i.showAlert("danger","Could not delete "+i.parent.gridId+": "+c)}i.parent.showAlert("success",i.gridId+" deleted successfully"),i.grid.refreshInfiniteCache(),i.grid.deselectAll(),i.closeDialog()},function(a){if(console.dir(a),"success"==a.status)return i.showActionButtons=!0,i.closeDialog(),i.parent.showAlert("success",i.gridId+" deleted successfully"),i.grid.refreshInfiniteCache(),void i.closeDialog();var b="Unknown error";a.data&&a.data.metadata&&a.data.metadata.description&&a.data.metadata.description.en?b=a.data.metadata.description.en:a.errorDetail&&(b=a.errorDetail),i.showAlert("danger","Could not delete "+i.parent.gridId+": "+b)})},i.confirmTokenAction=function(a){"delete"==a?(i.actionDelete=!0,i.tokenActionMsg="Are you sure you want to delete this token?"):"regenerate"==a&&(i.actionDelete=!1,i.tokenActionMsg="Are you sure you want to regenerate this token?"),i.showTokenButtons=!1},i.cancelTokenAction=function(){i.showTokenButtons=!0},i.cancelActionButtons=function(){i.showActionButtons=!0},i.showPromptMessage=function(b,c,d){i.isLoading=c,i.promptMessage={type:b,content:d},i.hidePromptMessage=!1,a(function(){i.hidePromptMessage=!0},5e3)},i.showAlert=function(a,b){this.message={type:a,content:b},i.hasAlert=!0},i.closeAlert=function(){i.hasAlert=!1},i.closeDialog=function(){f.hide()}}]),angular.module("Identity").controller("viewGroupDialogCtrl",["$timeout","grid","httpClient","parent","groupData","$mdDialog","$scope","groupInfo",function(a,b,c,d,e,f,g,h){var i=this;i.groupData=e,i.grid=b,i.groupInfo=h,i.groupName=e.name,i.parent=d,i.showActionButtons=!0,i.groupFetched=!1,i.init=function(){i.name=h.name?h.name:"N/A",null!=h.devices&&h.devices.length>0?h.devices instanceof Array?i.devices=h.devices:i.devices=[h.devices]:i.devices="N/A",i.groupFetched=!0,i.hidePromptMessage=!0},i.deleteGroup=function(){var a={name:i.groupName,module:"group"};c.post(identityConfig.group.apis.delete,a).then(function(a,b){if(a.status&&"failure"==a.status)return i.showActionButtons=!0,void i.showAlert("danger","Could not delete group, please try again later");i.parent.showAlert("success","Group deleted successfully"),i.grid.refreshInfiniteCache(),i.grid.deselectAll(),i.closeDialog()},function(a){if(console.dir(a),"success"==a.status)return i.showActionButtons=!0,i.closeDialog(),i.parent.showAlert("success","Group deleted successfully"),i.grid.refreshInfiniteCache(),void i.closeDialog();a.data&&a.data.metadata&&a.data.metadata.description&&a.data.metadata.description.en?a.data.metadata.description.en:a.errorDetail&&a.errorDetail,i.showAlert("danger","Could not delete group, please try again later")})},i.confirmationDeleteGroup=function(){i.showActionButtons=!1},i.cancelActionButtons=function(){i.showActionButtons=!0},i.editGroup=function(){i.closeDialog();var a=i.parent.identityForms.group;i.parent.loadEditGroupOverlay(i.groupData,a,identityConfig.group.apis.save)},i.showPromptMessage=function(b,c,d){i.isLoading=c,i.promptMessage={type:b,content:d},i.hidePromptMessage=!1,a(function(){i.hidePromptMessage=!0},5e3)},i.showAlert=function(a,b){this.message={type:a,content:b},i.hasAlert=!0},i.closeAlert=function(){i.hasAlert=!1},i.closeDialog=function(){f.hide()}}]);var identityConfig={theme:"identityTheme",group:{apis:{list:"identity/api/groups/listGroups",delete:"identity/api/deleteIdentity",save:"identity/api/groups/saveGroup",getGroupDevices:"identity/api/groups/getGroupDevices",getGroupDevicesToView:"identity/api/groups/getGroupDevicesToView"},identifierProperty:"name"},device:{apis:{list:"identity/api/devices/listDevices",delete:"identity/api/deleteIdentity",save:"identity/api/devices/saveDevice",get:"identity/api/getIdentity",generate:"identity/api/devices/generateTokens",revoke:"identity/api/devices/revokeToken"},identifierProperty:"id"},reports:{apis:{export:"identity/api/reports/scheduleExport",import:"identity/api/reports/scheduleImport",getCSV:"identity/api/reports/getCSVFile",template:"identity/api/reports/getCSVTemplate"}},user:{apis:{delete:"identity/api/deleteIdentity",get:"identity/api/getIdentity",list:"identity/api/users/listUsers",save:"identity/api/users/saveUser"},identifierProperty:"id"}},menuItems={mainMenu:"col1",col1:[{id:"1",iconClass:"fa fa-user",label:"Identity Management",route:"#/identitymanagement",active:"true"}]},headerItems={logo:"https://blog.scriptr.io/wp-content/uploads/2016/10/logo-1.png",items:[],logout:{route:"#/logout"}},routingItems={params:[{route:"identitymanagement",template:"/identity/view/html/views/identityMain.html"},{route:"logout",template:"/login/view/logout.html"}]},httpsConfig=["httpClientProvider",function(a){}],wssConfig=["wsClientProvider",function(a){a.preventConnectionSetup(!0)}],myApp=angular.module("myApp",["underscore","Layout","Identity"]);myApp.constant("menuItemsJson",menuItems).constant("headerItemsJson",headerItems).constant("routingJson",routingItems).config(httpsConfig).config(wssConfig).config(["$routeProvider","routingJson",function(a,b){for(var c=0;c<b.params.length;c++)a.when("/"+b.params[c].route,{templateUrl:b.params[c].template,controller:b.params[c].controller,reloadOnSearch:!1,routeDef:b.params[c].routeDef});a.otherwise("/identitymanagement")}]),angular.module("Identity").component("formOverlay",{bindings:{resolve:"<",close:"&",dismiss:"&"},templateUrl:"/identity/view/javascript/components/forms/overlayForm.html",controller:["$scope",function(a){var b=this;this.$onInit=function(){this.widget=this.resolve.widget,a.$broadcast("schemaFormRedraw"),this.frmGlobalOptions={destroyStrategy:"remove",formDefaults:{feedback:!1},validationMessage:{302:"Required"}},this.widget&&(this.widget.schema&&(this.schema=angular.copy(this.widget.schema)),this.widget.form&&(this.form=angular.copy(this.widget.form)),this.model=this.widget.model?angular.copy(this.widget.model):{},this.widget.onFormModelChange&&(this.frmGlobalOptions.formDefaults.onChange=this.widget.onFormModelChange))},this.highlightTabs=function(a){var b=$('form[name="'+a+'"]'),c=b.find("ul li"),d=b.find(".tab-pane")||[];b.find("ul li a span.badge").remove();for(var e=0;e<d.length;e++){var f=$(d[e]).find("div.ng-invalid").length;f>0&&$(c[e].childNodes[0]).append('<span class="badge sf-badge-error">'+f+"</span>")}},this.onSubmit=function(c){a.$broadcast("schemaFormValidate"),console.log(this.model),setTimeout(function(){b.highlightTabs(c.$name)},100),c.$valid&&(this.close({$value:this.model}),console.log("component_form_parent",this.model))},this.onCancel=function(a){this.schema={},this.form={},this.model=angular.copy(this.widget.options),this.dismiss({$value:"cancel"})}}]}),angular.module("Identity").component("uploadFileComponent",{bindings:{resolve:"<",close:"&",dismiss:"&"},templateUrl:"/identity/view/javascript/components/forms/uploadFile.html",controller:["$scope","httpClient","$q","$loadingOverlay","identityFactory",function(a,b,c,d,e){var f=this;f.showLoading=!1,this.$onInit=function(){console.log(a),this.widget=this.resolve.widget,f.gridType=this.resolve.widget.parent.gridEventsId,this.gridTypeToUpperCase=f.gridType.charAt(0).toUpperCase()+f.gridType.substring(1),a.$broadcast("schemaFormRedraw"),this.frmGlobalOptions={destroyStrategy:"remove",formDefaults:{feedback:!1}},this.widget&&(this.parent=this.widget.parent,this.widget.schema&&(this.schema=angular.copy(this.widget.schema)),this.widget.form&&(this.form=angular.copy(this.widget.form)),this.model=this.widget.model?angular.copy(this.widget.model):{},this.widget.onFormModelChange&&(this.frmGlobalOptions.formDefaults.onChange=this.widget.onFormModelChange))},this.onCancel=function(a){this.schema={},this.form={},this.model=angular.copy(this.widget.options),this.dismiss({$value:"cancel"})},this.save=function(g){if(a.$broadcast("schemaFormValidate"),g.$valid){f.showLoading=!0,d.show('<i class="fa fa-spinner fa-spin fa-1x"></i>&nbsp;<b>Uploading CSV, please wait...</b>');var h=c.defer(),i=new FormData;for(var j in this.model)Array.isArray(this.model[j])?_.forEach(this.model[j],function(a){i.append(j,a)}):i.append(j,this.model[j]);return i.append("gridType",f.gridType),b.post(identityConfig.reports.apis.import,i,null,!0).then(function(a,b){"failure"==a.status?(f.showLoading=!1,f.showAlert("danger",a.errorDetail)):e.getJobStatus(identityConfig.reports.apis.import,{scriptHandleId:a.scriptHandleId},30,function(c){f.showLoading=!1,c.status&&"success"==c.status?(f.showAlert("success","The "+f.gridType+"s have been imported successfully"),f.parent._createNewDatasource(),
h.resolve(a,b)):(f.showAlert("danger",c.errorDetail?c.errorDetail:"Failed to import "+f.gridType+"s"),h.reject(c.errorCode,c.errorDetail))},function(a){f.showAlert("danger",a||"Failed to import "+f.gridType+"s"),f.showLoading=!1,h.reject(a)})},function(a){f.showAlert("danger",a.data.response.metadata.errorDetail),f.showLoading=!1,h.reject(a)}),h.promise}},this.downloadTemplate=function(){var a={type:f.gridType,fileName:f.gridType+"sTemplate.csv"};b.post(identityConfig.reports.apis.template,a).then(function(b,c){if(f.showLoading=!1,"failure"==b.status)f.showAlert("danger","Unable to download template, please try again");else{f.showAlert("success","Template downloaded successfully");var d=document.createElement("a");d.setAttribute("href","data:text/csv;charset=utf-8,"+b.data),d.setAttribute("download",a.fileName),d.style.display="none",document.body.appendChild(d),d.click(),document.body.removeChild(d)}},function(a){f.showLoading=!1,f.showAlert("danger","Unable to download template, please try again")})},this.showAlert=function(a,b){d.hide(),this.message={type:a,content:b},this.hasAlert=!0},this.closeAlert=function(){this.hasAlert=!1}}]}),agGrid.initialiseAgGridWithAngular1(angular),angular.module("Identity").component("scriptrIdentityGrid",{bindings:{onLoad:"&onLoad",gridDataIdentifierProperty:"@",columnsDefinition:"<columnsDefinition",rowHeight:"<?",enableServerSideSorting:"<?",enableServerSideFilter:"<?",refreshOnEdit:"<?",enableColResize:"<?",pagination:"@",enableDeleteRow:"<?",enableAddRow:"<?",cellEditable:"<?",enableClientSideSorting:"<?",api:"@",onInsertRowScript:"@",onDeleteRowScript:"@",transport:"@",enableClientSideFilter:"<?",rowModelType:"@",rowModelSelection:"@",suppressRowClickSelection:"<?",suppressCellSelection:"<?",rowDeselection:"<?",onSelectionChanged:"&?",rowData:"<?",suppressFilter:"<?",gridHeight:"@",paginationPageSize:"<?",paginationOverflowSize:"<?",maxConcurrentDatasourceRequests:"<?",paginationInitialRowCount:"<?",maxPagesInCache:"<?",apiParams:"<?",deleteParams:"<?",addParams:"<?",editParams:"<?",onFormatData:"&",onCellValueChanged:"&",onCellClicked:"&",msgTag:"@",class:"@",defaultCellRenderer:"&",onGridReady:"&",useWindowParams:"@",onRowDoubleClicked:"&",sizeColumnsToFit:"<?",gridEventsId:"@",removeRowConfig:"<?",saveRowConfig:"<?",customNoRowsLabel:"@"},templateUrl:"/identity/view/javascript/components/grid/grid.html",controller:["$scope","$window","$uibModal","$timeout","identityForms","wsClient","dataStore","identityFactory","$routeParams","httpClient","$route","$timeout","$q","$loadingOverlay",function(a,b,c,d,e,f,h,i,j,k,l,d,m,n){var o=this;o.broadcastData=null,this.identityForms=e,this.dataSource={getRows:function(a){if(null!=o.broadcastData){if(null!=o.broadcastData.api)var b=o.broadcastData.api;else var b=o.api;if(null!=o.broadcastData.params&&(o.apiParams=o.broadcastData.params),null!=o.broadcastData.transport)var c=o.broadcastData.transport;else var c=o.transport}else var b=o.api,c=o.transport;var d=o.buildParams(a),e=null;"function"==typeof o.onFormatData()&&(e=function(a){return o.onFormatData()(a)}),h.getGridData(b,d,c,e).then(function(b,c){if(b&&b.documents){var d=b.documents,e=parseInt(b.count),f=o.cleanRows(d);if(a.successCallback(f,e),o.sizeColumnsToFit&&o.gridOptions.api.sizeColumnsToFit(),o.gridOptions.api.doLayout(),null==f||0==f.length){o.gridOptions.api.showNoRowsOverlay();angular.element(document.querySelector("#btNext")).attr("disabled","true"),0==e&&(angular.element(".ag-paging-page-summary-panel > span[ref=lbTotal]")[0].innerHTML=1)}else o.gridOptions.api.hideOverlay()}else a.failCallback(),o.gridOptions.api.showNoRowsOverlay()},function(a){console.log("reject",a)})}},this.$onDestroy=function(){o.msgTag&&f.unsubscribe(o.msgTag,null,a.$id)},this.cleanRows=function(a){Array.isArray(a)||(a=[a]);for(var b=!1,c=0;c<a.length;c++)for(row in a[c])if("key"!=row){b=!1;for(var d=0;d<o.gridOptions.columnDefs.length;d++)if(row==o.gridOptions.columnDefs[d].field){b=!0;break}b||delete a[c][row]}return a},this._createNewDatasource=function(){this.gridOptions.api.setDatasource(this.dataSource)},this.$onInit=function(){this._dataIdentifierProperty=this.gridDataIdentifierProperty?this.gridDataIdentifierProperty:"key",this.useWindowParams=this.useWindowParams?this.useWindowParams:"true",this.noRowsLabel=this.customNoRowsLabel?this.customNoRowsLabel:"No Results To Show",this.sizeColumnsToFit=void 0===this.sizeColumnsToFit||this.sizeColumnsToFit,this.gridOptions={angularCompileRows:!0,domLayout:"autoHeight",rowHeight:this.rowHeight?this.rowHeight:25,enableSorting:void 0===this.enableClientSideSorting||this.enableClientSideSorting,enableServerSideSorting:void 0===this.enableServerSideSorting||this.enableServerSideSorting,enableServerSideFilter:void 0===this.enableServerSideFilter||this.enableServerSideFilter,enableColResize:void 0!==this.enableColResize&&this.enableColResize,enableFilter:!0,columnDefs:this.columnsDefinition,pagination:void 0!==this.pagination&&this.pagination,cacheBlockSize:this.paginationPageSize?this.paginationPageSize:50,rowData:this.rowData?this.rowData:null,rowModelType:"infinite",rowSelection:this.rowModelSelection?this.rowModelSelection:"multiple",suppressRowClickSelection:!this.suppressRowClickSelection||this.suppressRowClickSelection,suppressCellSelection:!this.suppressCellSelection||this.suppressCellSelection,paginationPageSize:this.paginationPageSize?this.paginationPageSize:50,overlayNoRowsTemplate:'<span class="ag-overlay-no-rows-center">'+this.noRowsLabel+"</span>",overlayLoadingTemplate:'<span class="ag-overlay-loading-center"><i class="fa fa-spinner fa-spin fa-fw fa-2x"></i>Loading...</span>',defaultColDef:{filter:!1,filterParams:{apply:!1},suppressFilter:void 0===this.suppressFilter||this.suppressFilter,editable:void 0===this.cellEditable||this.cellEditable,cellRenderer:"function"==typeof this.defaultCellRenderer()?this.defaultCellRenderer():null},onSelectionChanged:function(){if(null!=o.onSelectionChanged&&"function"==typeof o.onSelectionChanged())return o.onSelectionChanged()(o.gridOptions,o.gridApi)},onCellClicked:function(a){if(null!=o.onCellClicked&&"function"==typeof o.onCellClicked())return o.onCellClicked()(a,o.gridOptions,o.gridApi)},onCellValueChanged:function(a){},onRowValueChanged:function(a){},onGridReady:function(a){if(console.log("the grid is now ready"),d(function(){o.gridOptions.api=a.api,o.gridApi=a.api},3e3),"function"==typeof o.onGridReady()&&o.onGridReady()(o),a.api.filterManager.availableFilters.text.CONTAINS="startsWith",void 0===o.rowData||null==o.rowData||o.rowData&&0==o.rowData.length?o.api?o._createNewDatasource():a.api.setRowData([]):o.sizeColumnsToFit&&a.api.sizeColumnsToFit(),this.columnsDefinition)for(var b=0;b<this.columnsDefinition.length;b++)this.columnsDefinition[b].hasOwnProperty("type")&&"numeric"==this.columnsDefinition[b].type&&(this.columnsDefinition[b].filter="number")},onGridSizeChanged:function(a){o.sizeColumnsToFit&&o.gridOptions.api.sizeColumnsToFit()}},null!=o.onRowDoubleClicked&&"function"==typeof o.onRowDoubleClicked()&&(o.gridOptions.onRowDoubleClicked=function(a){return o.onRowDoubleClicked()(a)}),this.style={height:"100%",width:"100%"},this.refreshOnEdit=void 0!==this.refreshOnEdit&&this.refreshOnEdit,this.transport=this.transport?this.transport:"wss",this.disableDeleteRow=1!=this.enableDeleteRow,this.disableAddRow=1!=this.enableAddRow,this.mode="infinite"==this.gridOptions.rowModelType?"infinite":"normal",o.msgTag&&h.subscribe(this.onServerCall,o.msgTag,a),a.$on("updateGridData-"+o.gridEventsId,function(a,b){o.broadcastData=b,o._createNewDatasource()}),a.$on("showGridAlert-"+o.gridEventsId,function(a,b){o.broadcastData=b,o.showAlert(o.broadcastData.type,o.broadcastData.content)})},this.closeAlert=function(){this.show=!1},this.showAlert=function(a,b){n.hide(),o.message={type:a,content:b},o.showError=!0,d(function(){o.showError=!1},5e3)},this._saveData=function(a){if(a.data&&a.data[o._dataIdentifierProperty]){var b=a.data;if(b.action="edit",this.editParams)for(var c in this.editParams)b[c]=this.editParams[c];h.gridHelper(o.api,b).then(function(a,b){o.gridOptions.api.hideOverlay(),!a||"success"!=a.result&&"success"!=a.status?(o.undoChanges(),a&&a.errorDetail?o.showAlert("danger",a.errorDetail):o.showAlert("danger","An error has occurred. Please try again later.")):o.refreshOnEdit&&o.onServerCall(a)},function(a){o.gridOptions.api.hideOverlay(),console.log("reject",a),o.showAlert("danger","An error has occurred. Please try again later.")})}else{var b=a.data;if(b.action="add",this.addParams)for(var c in this.addParams)b[c]=this.addParams[c];h.gridHelper(o.api,a.data).then(function(a,b){o.gridOptions.api.hideOverlay(),!a||"success"!=a.result&&"success"!=a.status?(o.undoChanges(),a&&a.errorDetail?o.showAlert("danger",a.errorDetail):o.showAlert("danger","An error has occurred. Please try again later.")):o.refreshOnEdit&&o.onServerCall(a)},function(a){o.gridOptions.api.hideOverlay(),console.log("reject",a),g,o.showAlert("danger","An error has occurred. Please try again later.")})}},this.onAddRow=function(){o.loadOverlay(null,this.saveRowConfig.schemaFormDefinition,this.saveRowConfig.api)},this.loadOverlay=function(b,d,e){var f=angular.copy(d);f.title="Add "+f.title;var g={label:f.title,buttons:{save:{label:"Save"},cancel:{label:"Cancel"}},schema:angular.copy(f.schema),form:angular.copy(f.form),options:{}},h=this;c.open({animation:!0,component:"formOverlay",size:"lg",scope:a,resolve:{widget:function(){return g}}}).result.then(function(a){if("cancel"!=a){var b=function(a){if("group"==h.gridEventsId)null!=a.scriptHandleId&&""!=a.scriptHandleId?(n.show('<i class="fa fa-spinner fa-spin fa-1x"></i>&nbsp;<b>Saving group and updating devices...</b>'),i.getJobStatus(e,{scriptHandleId:a.scriptHandleId},30,function(a){a&&"success"==a?(h._createNewDatasource(),h.showAlert("success","Successfully saved group and updated devices")):h.showAlert("warning",a)},function(a){h.showAlert("warning","Successfully saved group. Error when updating devices")})):(h._createNewDatasource(),h.showAlert("success","Group saved successfully"));else{var b=h.gridEventsId.charAt(0).toUpperCase()+h.gridEventsId.substring(1);h._createNewDatasource(),h.showAlert("success",b+" saved successfully")}},c=function(a){var b="Unknown error";a.data&&a.data.metadata&&a.data.metadata.description&&a.data.metadata.description.en?b=a.data.metadata.description.en:a.errorDetail&&(b=a.errorDetail),h.showAlert("danger","Could not save "+h.gridEventsId+": "+b)};h.callBackendApiPost(e,a,b,c)}},function(){console.info("modal-component for widget update dismissed at: "+new Date)})},this.callBackendApiPost=function(a,b,c,d){console.log("POST calling backend api <"+a+"> with params "+JSON.stringify(b)),o._callBackendApi(a,b,"P",c,d)},this._callBackendApi=function(a,b,c,d,e){var f=k.post;"G"==c&&(f=k.get),f(a,b).then(function(a,b){console.log(a),a&&a.status&&"failure"==a.status?"function"==typeof e&&e(a):"function"==typeof d&&d(a)},function(a){console.log(a),"function"==typeof e&&e(a)})},this.openConfirmationPopUp=function(){if(o.gridOptions.api.getSelectedNodes().length>0){c.open({animation:!0,component:"deleteConfirmationOverlay",size:"lg",scope:a,resolve:{grid:function(){return o}}})}else o.showAlert("danger","No row(s) selected")},this.confirmRefreshTokensPopUp=function(){if(o.gridOptions.api.getSelectedNodes().length>0){c.open({animation:!0,component:"confirmRefreshTokenPopup",size:"lg",scope:a,resolve:{grid:function(){return o}}})}else o.showAlert("danger","No device(s) selected")},this.refreshTokens=function(){for(var a=o.gridOptions.api.getSelectedNodes(),b=[],c=0;c<a.length;c++)b.push(a[c].data[o._dataIdentifierProperty]);if(b.length>0){var d={id:b};k.post(identityConfig.device.apis.generate,d).then(function(a,b){null!=a.scriptHandleId&&""!=a.scriptHandleId?(n.show('<i class="fa fa-spinner fa-spin fa-1x"></i>&nbsp;<b>Refreshing Token(s)...</b>'),i.getJobStatus(identityConfig.device.apis.generate,{scriptHandleId:a.scriptHandleId},30,function(b){if(n.hide(),o.showTokenButtons=!0,b.status&&"failure"==b.status){return b.errorDetail&&(b=a.errorDetail),void o.showAlert("danger","Unable to refresh token(s), please try again later.")}o.token=b.token?b.token:"N/A",o._createNewDatasource(),o.gridOptions.api.deselectAll(),o.showAlert("success","Token(s) refreshed successfully")},function(a){o.showTokenButtons=!0;a.data&&a.data.metadata&&a.data.metadata.description&&a.data.metadata.description.en?a.data.metadata.description.en:a.errorDetail&&a.errorDetail,o.showAlert("danger","Unable to refresh token(s), please try again later.")})):o.showAlert("danger","Unable to refresh token(s), please try again later.")},function(a){o.showAlert("danger","Unable to refresh token(s), please try again later.")})}else o.showAlert("danger","No device(s) selected")},this.exportData=function(){n.show('<i class="fa fa-spinner fa-spin fa-1x"></i>&nbsp;<b>Exporting file, please wait...</b>');var a={gridType:o.gridEventsId,queryFilter:o.serverFilterText};k.post(identityConfig.reports.apis.export,a).then(function(b,c){"failure"==b.status?o.showAlert("danger","Unable to export, please try again"):i.getJobStatus(identityConfig.reports.apis.export,{scriptHandleId:b.scriptHandleId},30,function(b){a.docKey=b,k.get(identityConfig.reports.apis.getCSV,a).then(function(a,b){o.showAlert("success","Data exported successfully");var c=document.createElement("a");c.setAttribute("href","data:text/csv;charset=utf-8,"+a.data),c.setAttribute("download",o.gridEventsId+"s.csv"),c.style.display="none",document.body.appendChild(c),c.click(),document.body.removeChild(c)},function(a){o.showAlert("danger","Unable to export, please try again")})},function(a){o.showAlert("danger","Unable to export, please try again")})},function(a){o.showAlert("danger","Unable to export, please try again")})},this.loadImportOverlay=function(){var b=angular.copy(this.identityForms.uploaderForm),d=angular.copy(b.form),e=this,f={label:b.title,buttons:{save:{label:"Save"},cancel:{label:"Cancel"}},schema:angular.copy(b.schema),form:d,model:{},parent:e};c.open({animation:!0,component:"uploadFileComponent",size:"lg",scope:a,resolve:{widget:function(){return f}}}).result.then(function(a){},function(){console.info("modal-component for widget update dismissed at: "+new Date)})},this.onRemoveRow=function(a){if("infinite"==o.gridOptions.rowModelType)if(o.removeRowConfig&&o.removeRowConfig.api){n.show('<i class="fa fa-spinner fa-spin fa-1x"></i>&nbsp;<b>Deleting row(s)...</b>');for(var b=o.removeRowConfig.api,c=o.gridOptions.api.getSelectedNodes(),d=[],e=0;e<c.length;e++)d.push(c[e].data[o._dataIdentifierProperty]);if(d.length>0){var f={};o.removeRowConfig.queryParam?f[o.removeRowConfig.queryParam]=d:f[o._dataIdentifierProperty]=d,f.module=o.gridEventsId,h.postGridHelper(b,f).then(function(a,c){d.length>1?"failure"==a.status?o.showAlert("danger","Unable to delete row(s), please try again"):i.getJobStatus(b,{scriptHandleId:a.scriptHandleId},30,function(a){o.gridOptions.api.hideOverlay(),!a||"success"!=a.result&&"success"!=a.status?a&&a.errorDetail?o.showAlert("danger",a.errorDetail):o.showAlert("danger","Unable to delete row(s), please try again"):(o.showAlert("success","Row(s) deleted successfully"),o.onServerCall(),o.gridOptions.api.deselectAll())},function(a){o.gridOptions.api.hideOverlay(),console.log("failure",a),o.showAlert("danger","Unable to delete row(s), please try again")}):(o.gridOptions.api.hideOverlay(),!a||"success"!=a.result&&"success"!=a.status?a&&a.errorDetail?o.showAlert("danger",a.errorDetail):o.showAlert("danger","Unable to delete row(s), please try again"):(o.showAlert("success","Row(s) deleted successfully"),o.onServerCall(),o.gridOptions.api.deselectAll()))},function(a){o.gridOptions.api.hideOverlay(),console.log("reject",a),o.showAlert("danger","An error has occurred. Please try again later.")})}}else o.showAlert("danger","No script defined for delete row");else{var c=o.gridOptions.api.getSelectedNodes();o.gridOptions.api.removeItems(c)}},this.onServerCall=function(a){o.gridOptions.api.refreshInfiniteCache()},this.undoChanges=function(a){if(o.oldEditedValue){o.gridOptions.api.forEachNode(function(a){a.childIndex!=o.editedChildIndex&&a.id!=o.editedChildIndex||a.setSelected(!0,!0)});o.gridOptions.api.getSelectedNodes()[0].data[o.editedColumn]=o.oldEditedValue,o.gridOptions.api.refreshView()}else o.gridOptions.api.refreshInfiniteCache()},this.onFilterChanged=function(){this.gridOptions.enableServerSideFilter=!1,this.gridOptions.api.setQuickFilter(this.quickFilterValue),this.gridOptions.enableServerSideFilter=!0},this.onServerFilterChanged=function(){null==o.timeoutId&&(o.timeoutId=d(function(){},1e3).then(function(){o.timeoutId=null,o._createNewDatasource()}))},this.buildParams=function(a){var b=o.serverFilterText,c=null,d=a.endRow/this.gridOptions.paginationPageSize;if(a.sortModel&&a.sortModel.length>0){var e=a.sortModel[0].sort,f=a.sortModel[0].colId;c=this.gridOptions.api.getColumnDef(f).type?this.gridOptions.api.getColumnDef(f).type:null}if(a.filterModel)for(p in a.filterModel){b=a.filterModel[p].filter;var g=a.filterModel[p].type,h=p;c=this.gridOptions.api.getColumnDef(h).type?this.gridOptions.api.getColumnDef(h).type:null}var i={resultsPerPage:this.gridOptions.paginationPageSize,pageNumber:d};if(f&&(i.sortingColumnName=f),h&&(i.filterColumnName=h),e&&(i.sort=e),c&&(i.sortType=c),b&&(i.queryFilter=b),g&&(i.queryType=g),i.startRow=a.startRow,i.endRow=a.endRow,this.apiParams)for(var k in this.apiParams)i[k]=this.apiParams[k];return o.useWindowParams&&"true"==o.useWindowParams&&(i=angular.merge(i,j)),i}}]}),angular.module("Identity").service("dataStore",["httpClient","wsClient","$q",function(a,b,c){this.subscribe=function(a,c,d){b.onReady.then(function(){b.subscribe(c,a.bind(self),d.$id)})},this.gridHelper=function(b,d){var e=c.defer();return a.get(b,d).then(function(a,b){e.resolve(a,b)},function(a){e.reject(a)}),e.promise},this.postGridHelper=function(b,d){var e=c.defer();return a.post(b,d).then(function(a,b){e.resolve(a,b),console.log(a)},function(a){e.reject(a),console.log(a)}),e.promise},this.getGridData=function(d,e,f,g){var h=c.defer();return"https"==f?(a.get(d,e).then(function(a,b){if(g&&(a=g(a)),a&&a.documents){var a={documents:a.documents,count:a.count};h.resolve(a,b)}else h.resolve(null,b)},function(a){h.resolve(null),h.reject(a)}),h.promise):"wss"==f?d&&void 0!==d?(b.onReady.then(function(){b.call(d,e,"grid").then(function(a,b){if(g&&(a=g(a)),a&&a.documents){var a={documents:a.documents,count:a.count};h.resolve(a,b)}else h.resolve(null,b)},function(a){h.resolve(null),h.reject(a)})}),h.promise):(b.onReady.then(function(){b.publish(e,"publish").then(function(a,b){if(a&&a.documents){var a={documents:a.documents,count:a.count};h.resolve(a,b)}else h.resolve(null,b)},function(a){h.resolve(null),h.reject(a)})}),h.promise):void 0}}]),angular.module("Identity").component("deleteConfirmationOverlay",{bindings:{resolve:"<",close:"&",dismiss:"&"},templateUrl:"/identity/view/javascript/components/grid/popup.html",controller:["$scope",function(a){this.$onInit=function(){this.title="Delete",this.bodyMessage="Are you sure you want to delete the selected row(s)?",this.onSubmit=function(){this.resolve.grid.onRemoveRow(),this.close({$value:!0})},this.onCancel=function(){this.dismiss({$value:!1})}}}]}),angular.module("Identity").component("confirmRefreshTokenPopup",{bindings:{resolve:"<",close:"&",dismiss:"&"},templateUrl:"/identity/view/javascript/components/grid/popup.html",controller:["$scope",function(a){this.$onInit=function(){this.title="Generate/Regenerate Token(s)",this.bodyMessage="Are you sure you want to generate/regenerate the tokens of the selected row(s)?",this.onSubmit=function(){this.resolve.grid.refreshTokens(),this.close({$value:!0})},this.onCancel=function(){this.dismiss({$value:!1})}}}]}),angular.module("Identity").factory("identityFactory",["httpClient",function(a){var b={};return b.getJobStatus=function(c,d,e,f,g){e>0?(e-=1,a.get(c,d).then(function(a,h){if(console.dir(a),"complete"==a.jobStatus){var i=JSON.parse(a.jobResult);if("success"==i.resultJSON.response.metadata.status)return void f(i.resultJSON.response.result);g("An error has occurred. Please try again later.")}setTimeout(b.getJobStatus,1e3,c,d,e,f,g)},function(a){g(a)})):g("TIME_OUT")},b}]),angular.module("Identity").constant("identityForms",{group:{title:"Group",form:[{type:"section",htmlClass:"row",items:[{type:"section",htmlClass:"col-xs-6",items:[{key:"name",validationMessage:{201:"Name is too long ({{viewValue.length}} chars), maximum allowed is {{schema.maxLength}}."}}]}]},{type:"section",htmlClass:"row",items:[{key:"devices",type:"uiselectmultiple",htmlClass:"col-xs-12",placeholder:"Select Devices",options:{multiple:!0,closeOnSelect:!0,httpGet:{url:identityConfig.device.apis.list,parameter:'{"count": false, "fields": "id,name"}'},map:{valueProperty:"id",nameProperty:"name"}}}]}],schema:{type:"object",title:"groupSchema",properties:{name:{title:"Group Name",type:"string",maxLength:116},devices:{type:"array",title:"Devices",description:"Select your group devices",items:{type:"object"}}},required:["name"]}},device:{title:"Device",form:[{type:"section",htmlClass:"row",items:[{type:"section",htmlClass:"col-xs-12 col-sm-6",items:[{key:"name",validationMessage:{201:"Name is too long ({{viewValue.length}} chars), maximum allowed is {{schema.maxLength}}."}}]},{type:"section",htmlClass:"col-xs-12 col-sm-6",items:[{key:"id",validationMessage:{201:"ID is too long ({{viewValue.length}} chars), maximum allowed is {{schema.maxLength}}."}}]}]},{type:"section",htmlClass:"row",items:[{type:"section",htmlClass:"col-xs-12 col-sm-6",items:[{key:"password",type:"password",ngModelOptions:{allowInvalid:!0},onChange:function(a,b,c,d){console.log(c),a!=c.confirmPassword?d.$root.$broadcast("schemaForm.error.newPassword","doNotMatch",!1):(d.$root.$broadcast("schemaForm.error.newPassword","doNotMatch",!0),d.$root.$broadcast("schemaForm.error.confirmPassword","doNotMatch",!0))}}]},{type:"section",htmlClass:"col-xs-12 col-sm-6",items:[{key:"confirmPassword",type:"password",condition:"model.password",required:!0,ngModelOptions:{allowInvalid:!0},onChange:function(a,b,c,d){console.log(c),a!=c.password?d.$root.$broadcast("schemaForm.error.confirmPassword","doNotMatch",!1):(d.$root.$broadcast("schemaForm.error.newPassword","doNotMatch",!0),d.$root.$broadcast("schemaForm.error.confirmPassword","doNotMatch",!0))}},{key:"confirmPassword",type:"password",condition:"!model.password",ngModelOptions:{allowInvalid:!0}}]}]},{type:"section",htmlClass:"row",items:[{type:"section",htmlClass:"col-xs-12",items:[{key:"description",validationMessage:{201:"Description is too long ({{viewValue.length}} chars), maximum allowed is {{schema.maxLength}}."}}]}]},{type:"section",htmlClass:"row",items:[{type:"section",htmlClass:"col-xs-12",items:[{type:"radios-inline",title:"Status",key:"isSuspended",titleMap:[{value:"false",name:"Active"},{value:"true",name:"Suspended"}]}]}]},{type:"section",htmlClass:"row",items:[{type:"section",htmlClass:"col-xs-12",items:[{type:"uiselectmultiple",placeholder:"Select Group",key:"groups",options:{httpGet:{url:identityConfig.group.apis.list,parameter:'{"count": false}'},map:{valueProperty:"name",nameProperty:"name"}}}]}]},{key:"_oldDeviceAttrs",type:"hidden",notitle:!0,onFieldLoad:function(a,b,c){c._oldDeviceAttrs=_.pluck(c.deviceAttrs,"name")}},{type:"section",htmlClass:"",items:[{key:"deviceAttrs",title:"Device Attributes",items:[{type:"section",htmlClass:"row",items:[{type:"section",htmlClass:"col-xs-6 col-sm-3",items:[{key:"deviceAttrs[].name",title:"name"}]},{type:"section",htmlClass:"col-xs-6 col-sm-3",items:[{type:"select",key:"deviceAttrs[].type",placeholder:"select type",titleMap:[{value:"string",name:"string"},{value:"numeric",name:"numeric"},{value:"date",name:"date"},{value:"text",name:"text"},{value:"geospatial",name:"geospatial"}],title:"type"}]},{type:"section",htmlClass:"col-xs-6 col-sm-3",items:[{key:"deviceAttrs[].value",title:"value"}]}]}]}]}],schema:{type:"object",title:"deviceSchema",properties:{name:{title:"Device",type:"string",maxLength:1024},id:{title:"Device ID",type:"string",maxLength:117},password:{title:"Password",type:"string",validationMessage:{doNotMatch:"Passwords do not match"},"x-schema-form":{type:"password"}},confirmPassword:{title:"Confirm Password",type:"string",validationMessage:{doNotMatch:"Passwords do not match"},"x-schema-form":{type:"password"}},description:{title:"Description",type:"string",maxLength:1024,"x-schema-form":{type:"textarea",placeholder:"Description for this device"}},groups:{type:"array",title:"Groups",items:{type:"object"}},isSuspended:{title:"Status",type:"string",default:"false"},deviceAttrs:{title:"Device Attributes",type:"array",items:{type:"object",properties:{name:{title:"Name",type:"string"},type:{title:"type",type:"string",placeholder:"select type"},value:{title:"Value",type:"string"}}}},_oldDeviceAttrs:{type:"string"}},required:["name","id","password","confirmPassword"]}},user:{title:"User",form:[{type:"section",htmlClass:"row",items:[{type:"section",htmlClass:"col-xs-12 col-sm-6",items:[{key:"name",validationMessage:{201:"Name is too long ({{viewValue.length}} chars), maximum allowed is {{schema.maxLength}}."}}]},{type:"section",htmlClass:"col-xs-12 col-sm-6",items:[{key:"id",validationMessage:{201:"login username is too long ({{viewValue.length}} chars), maximum allowed is {{schema.maxLength}}."}}]}]},{type:"section",htmlClass:"row",items:[{type:"section",htmlClass:"col-xs-12 col-sm-6",items:[{key:"password",type:"password",ngModelOptions:{allowInvalid:!0},onChange:function(a,b,c,d){console.log(c),a!=c.confirmPassword?d.$root.$broadcast("schemaForm.error.newPassword","doNotMatch",!1):(d.$root.$broadcast("schemaForm.error.newPassword","doNotMatch",!0),d.$root.$broadcast("schemaForm.error.confirmPassword","doNotMatch",!0))}}]},{type:"section",htmlClass:"col-xs-12 col-sm-6",items:[{key:"confirmPassword",type:"password",condition:"model.password",required:!0,ngModelOptions:{allowInvalid:!0},onChange:function(a,b,c,d){console.log(c),a!=c.password?d.$root.$broadcast("schemaForm.error.confirmPassword","doNotMatch",!1):(d.$root.$broadcast("schemaForm.error.newPassword","doNotMatch",!0),d.$root.$broadcast("schemaForm.error.confirmPassword","doNotMatch",!0))}},{key:"confirmPassword",type:"password",condition:"!model.password",ngModelOptions:{allowInvalid:!0},onChange:function(a,b,c,d){console.log(c),a!=c.password?d.$root.$broadcast("schemaForm.error.confirmPassword","doNotMatch",!1):(d.$root.$broadcast("schemaForm.error.newPassword","doNotMatch",!0),d.$root.$broadcast("schemaForm.error.confirmPassword","doNotMatch",!0))}}]}]},{type:"section",htmlClass:"row",items:[{type:"section",htmlClass:"col-xs-12",items:[{key:"email",validationMessage:{202:"Invalid email address"}}]}]},{type:"section",htmlClass:"row",items:[{type:"section",htmlClass:"col-xs-12",items:[{type:"radios-inline",title:"Status",key:"isSuspended",titleMap:[{value:"false",name:"Active"},{value:"true",name:"Suspended"}]}]}]},{type:"section",htmlClass:"row",items:[{type:"section",htmlClass:"col-xs-12",items:[{type:"uiselectmultiple",placeholder:"Select Group",key:"groups",options:{httpGet:{url:identityConfig.group.apis.list,parameter:'{"count": false}'},map:{valueProperty:"name",nameProperty:"name"}}}]}]},{key:"_oldUserAttrs",type:"hidden",notitle:!0,onFieldLoad:function(a,b,c){c._oldUserAttrs=_.pluck(c.userAttrs,"name")}},{type:"section",htmlClass:"",items:[{key:"userAttrs",title:"User Attributes",items:[{type:"section",htmlClass:"row",items:[{type:"section",htmlClass:"col-xs-6 col-sm-3",items:[{key:"userAttrs[].name",title:"name"}]},{type:"section",htmlClass:"col-xs-6 col-sm-3",items:[{type:"select",key:"userAttrs[].type",placeholder:"select type",titleMap:[{value:"string",name:"string"},{value:"numeric",name:"numeric"},{value:"date",name:"date"},{value:"text",name:"text"},{value:"geospatial",name:"geospatial"}],title:"type"}]},{type:"section",htmlClass:"col-xs-6 col-sm-3",items:[{key:"userAttrs[].value",title:"value"}]}]}]}]}],schema:{type:"object",title:"userSchema",properties:{name:{title:"User Name",type:"string",maxLength:1024},id:{title:"Login",type:"string",maxLength:1024},password:{title:"Password",type:"string",validationMessage:{doNotMatch:"Passwords do not match"},"x-schema-form":{type:"password"}},confirmPassword:{title:"Confirm Password",type:"string",validationMessage:{doNotMatch:"Passwords do not match"},"x-schema-form":{type:"password"}},email:{title:"Email Address",type:"string",pattern:"^[_a-zA-Z0-9-]+(\\.[_a-zA-Z0-9-]+)*@[a-zA-Z0-9-]+(\\.[a-zA-Z0-9-]+)*(\\.[a-zA-Z]{2,})$"},groups:{type:"array",title:"Groups",items:{type:"object"}},isSuspended:{title:"Status",type:"string",default:"false"},userAttrs:{title:"User Attributes",type:"array",items:{type:"object",properties:{name:{title:"Name",type:"string"},type:{title:"type",type:"string",placeholder:"select type"},value:{title:"Value",type:"string"}}}},_oldUserAttrs:{type:"string"}},required:["name","id","password","confirmPassword"]}},uploaderForm:{form:[{type:"section",items:[{type:"section",items:[{key:"csvFile",type:"nwpFileUpload",showProgress:!1,simpleImageUpload:!1,i18n:{add:"Open file browser",preview:"Preview Upload",filename:"File Name",progress:"Progress Status",upload:"Upload",dragorclick:"Drag and drop your file here or click here",required:"Required"},notitle:!1}]}]}],schema:{type:"object",title:"Schema",properties:{csvFile:{title:"File",type:"array",format:"singlefile","x-schema-form":{type:"array"},pattern:{mimeType:".csv",validationMessage:"Wrong File Type. Allowed types "},maxSize:{maximum:"10MB",validationMessage:"File exceeded allowed size of "}}},required:["csvFile"]}}});